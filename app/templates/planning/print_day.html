{% extends "base.html" %}
{% block title %}خروجی روزانه {{ day_j | to_persian_number }}{% endblock %}
{% block header %}خروجی روزانه — {{ day_j | to_persian_number }}{% endblock %}


{% block content %}
<style>
  @media print {
    .no-print { display: none !important; }
    body { background:#fff; }
  }
  .toolbar { display:flex; gap:.5rem; align-items:center; margin-bottom:.8rem; }
  .btn { border:1px solid #ddd; border-radius:8px; padding:.35rem .6rem; background:#fff; cursor:pointer; }
  .summary { display:flex; gap:1rem; flex-wrap:wrap; margin:.4rem 0 .9rem; }
  .sum-card { border:1px solid #eee; border-radius:10px; padding:.5rem .75rem; background:#fafafa; }
  .block { margin:.9rem 0; page-break-inside: avoid; }
  .block h3 { margin:.1rem 0 .4rem; }
  .cap { font-size:.85rem; color:#555; }
  .cap.over { color:#b00020; font-weight:600; }
  .card { border:1px solid #eee; border-radius:10px; padding:.45rem .6rem; margin:.35rem 0; display:flex; justify-content:space-between; gap:.5rem; }
  .card-main { min-width:0; }
  .title { font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:520px; }
  .meta { font-size:.85rem; color:#666; }
  .mcat { display:inline-block; padding:.05rem .4rem; border-radius:999px; font-size:.75rem; border:1px solid transparent; }
  .mcat-field { background:#eaf7ff; color:#036; border-color:#cfe8ff; }
  .mcat-adm { background:#eafff4; color:#064; border-color:#c8f3e0; }
  .mcat-desk { background:#fff6db; color:#7a5; border-color:#ffe9a3; }
  .mcat-unk { background:#f5f5f5; color:#666; border-color:#eee; }
</style>

{% set CAT_PERS = {'administrative':'اداری', 'field':'میدانی', 'desk':'دفتری', 'unknown':'نامشخص'} %}

<div class="toolbar no-print">
  <a class="btn" href="{{ url_for('projects.planning_week_page', date=day) }}" target="_blank">نمای هفته ↗</a>
  <button class="btn" onclick="window.print()">پرینت</button>
  <div style="margin-right:auto; color:#666; font-size:.85rem;">تاریخ تولید: {{ generated_at }}</div>
</div>

<div class="summary">
  <div class="sum-card">کل مأموریت‌ها: <strong>{{ summary.total }}</strong></div>
  <div class="sum-card">اداری: <strong>{{ summary.by_category['administrative'] }}</strong></div>
  <div class="sum-card">میدانی: <strong>{{ summary.by_category['field'] }}</strong></div>
  <div class="sum-card">دفتری: <strong>{{ summary.by_category['desk'] }}</strong></div>
  <div class="sum-card">نامشخص: <strong>{{ summary.by_category['unknown'] }}</strong></div>
  <div class="sum-card">وضعیت‌ها:
    {% for k, v in summary.by_status.items() %}
      <span style="margin-inline-start:.5rem;">{{ k }}: <strong>{{ v }}</strong></span>
    {% endfor %}
  </div>
</div>

{% for b in blocks %}
  {% set k = day ~ '_' ~ b %}
  {% set u = usage_day.get(k, {'used':0,'capacity':1,'over':False}) %}
  <div class="block">
    <h3>{{ b }} ({{ block_labels[b]['label'] }}) ·
      <span class="cap {% if u.over %}over{% endif %}">ظرفیت: {{ u.used }} / {{ u.capacity }}</span>
    </h3>

    {% set items = items_by_block.get(b, []) %}
    {% if not items %}
      <div class="meta">— موردی ثبت نشده است.</div>
    {% else %}
      {% for it in items %}
        {% set cat = it.category or 'unknown' %}
        {% set cls = 'mcat-' ~ ('adm' if cat=='administrative' else 'field' if cat=='field' else 'desk' if cat=='desk' else 'unk') %}
        <div class="card">
          <div class="card-main">
            <span class="mcat {{ cls }}">{{ CAT_PERS.get(cat,'نامشخص') }}</span>
            <div class="title" style="margin-top:.1rem;">{{ it.title }}</div>
            <div class="meta">{{ it.project_client or '—' }} — {{ it.project_goal or '—' }}</div>
            <div class="meta">موعد: {{ fmt_jalali(it.due_date) if it.due_date else '—' | to_persian_number }} · وضعیت: {{ it.status_label or it.status or '—' }}</div>
          </div>
          <div class="no-print" style="display:flex; align-items:center; gap:.4rem;">
            <a class="btn" href="/razmkar/{{ it.id }}" target="_blank" rel="noopener">باز کردن ↗</a>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>
{% endfor %}

{% endblock %}
