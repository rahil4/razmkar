{% extends "base.html" %}
{% block title %}Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ (AM/MID/PM){% endblock %}
{% block header %}Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ{% endblock %}

{% block content %}
<style>
 



  .planning-wrap { display:grid; grid-template-columns: 1fr 2fr; gap:1rem; }
  .pool, .grid { background:#fff; border:1px solid #eee; border-radius:10px; padding:.75rem; }
  .pool h3, .grid h3 { margin:.2rem 0 .6rem; }
  .controls { display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem; flex-wrap:wrap; }
  .textbox, .select, .btn { border:1px solid #ddd; border-radius:8px; padding:.35rem .6rem; background:#fff; }
  .btn { cursor:pointer; }
  .small { font-size:.8rem; color:#666; }
  .chip { border:1px solid #eee; border-radius:999px; padding:.05rem .45rem; font-size:.8rem; }

  .grid table { width:100%; border-collapse:collapse; }
  .grid th, .grid td { border:1px solid #f3f3f3; padding:.5rem; vertical-align:top; }
  .cell { min-height:84px; display:flex; flex-direction:column; gap:.35rem; }
  .item { display:flex; align-items:center; gap:.4rem; flex-wrap:wrap; }

  /* Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ */
  .mcat { display:inline-block; padding:.05rem .4rem; border-radius:999px; font-size:.75rem; border:1px solid transparent; }
  .mcat-field { background:#eaf7ff; color:#036; border-color:#cfe8ff; }
  .mcat-adm   { background:#eafff4; color:#064; border-color:#c8f3e0; }
  .mcat-desk  { background:#fff6db; color:#7a5; border-color:#ffe9a3; }
  .mcat-unk   { background:#f5f5f5; color:#666; border-color:#eee; }

  /* Ø¬Ø¯ÙˆÙ„ Ù…Ø¯Ø§Ù„ */
  .pool-table { width:100%; border-collapse:collapse; }
  .pool-table th, .pool-table td { border-bottom:1px solid #f3f3f3; padding:.4rem .5rem; text-align:right; }
  .pool-table th { background:#fafafa; }
  .nowrap { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:240px; }

  .cap { font-size:.8rem; color:#555; }
.cap.over { color:#b00020; font-weight:600; }
.cell.over { background:#fff3f3; }
.item.card {
  border:1px solid #eee;
  border-radius:10px;
  padding:.4rem .5rem;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:.5rem;
}
.card-main { min-width:0; }
.card-title { font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:280px; }
.card-meta { font-size:.8rem; color:#666; }
.card-actions { display:flex; gap:.35rem; }

  .gear-link {
    display:inline-block; margin-right:.4rem; border:1px solid #e5e5e5;
    padding:.1rem .45rem; border-radius:8px; text-decoration:none; color:#333;
    background:#fff; font-size:.9rem; line-height:1;
  }
  .gear-link:hover { background:#f7f7f7; }
</style>

{% set CAT_PERSIAN = {'administrative':'Ø§Ø¯Ø§Ø±ÛŒ', 'field':'Ù…ÛŒØ¯Ø§Ù†ÛŒ', 'desk':'Ø¯ÙØªØ±ÛŒ'} %}

<div class="controls">
  <form method="get" action="{{ url_for('projects.planning_week_page') }}">
    <input type="date" name="date" class="textbox" value="{{ base_date }}">
    <select name="category" class="select">
      <option value="all" {% if category=='all' %}selected{% endif %}>Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</option>
      <option value="administrative" {% if category=='administrative' %}selected{% endif %}>Ø§Ø¯Ø§Ø±ÛŒ</option>
      <option value="field" {% if category=='field' %}selected{% endif %}>Ù…ÛŒØ¯Ø§Ù†ÛŒ</option>
      <option value="desk" {% if category=='desk' %}selected{% endif %}>Ø¯ÙØªØ±ÛŒ</option>
    </select>
    <button class="btn" type="submit">Ù†Ù…Ø§ÛŒØ´</button>
  </form>
<div class="small">
  Ù‡ÙØªÙ‡: {{ week_from_j | to_persian_number }} ØªØ§ {{ week_to_j | to_persian_number }}
  Â· Ø¨Ù„ÙˆÚ©â€ŒÙ‡Ø§: {{ block_labels.AM.label }} / {{ block_labels.MID.label }} / {{ block_labels.PM.label }}
  <a class="gear-link" href="{{ url_for('projects.planning_settings_page') }}" title="ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ">âš™ï¸</a>
</div>
</div>

<div class="planning-wrap">
  <!-- Ø§Ø³ØªØ®Ø± Ù…Ø£Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§ (ØªÙˆØ¶ÛŒØ­) -->
  <section class="pool">
    <h3>
      Ù…Ø£Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§ (Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„
      {% if category != 'all' %} Â· {{ CAT_PERSIAN.get(category, 'â€”') }}{% endif %}
      )
    </h3>
    <div class="small">Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø£Ù…ÙˆØ±ÛŒØª Ø¨Ù‡ Ø¨Ù„ÙˆÚ©ØŒ Ø±ÙˆÛŒ Â«+ Ø§ÙØ²ÙˆØ¯Ù†Â» Ø¯Ø± Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÙˆÙ„ Ù‡ÙØªÙ‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.</div>
  </section>

  <!-- Ø¬Ø¯ÙˆÙ„ Ù‡ÙØªÙ‡ -->
  <section class="grid">
    <h3>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÙ‡</h3>
    <table>
      <thead>
        <tr>
          <th>Ø¨Ù„ÙˆÚ©/Ø±ÙˆØ²</th>
          {% for d in days %}
           <th>
  {{ days_map[d] | to_persian_number }}
  <a class="btn" href="{{ url_for('projects.planning_day_page', date=d) }}" target="_blank" title="Ø®Ø±ÙˆØ¬ÛŒ Ø±ÙˆØ²">ğŸ–¨</a>
</th>


          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for b in blocks %}
          <tr>
            <td>
              <strong>{{ b }}</strong>
              <div class="small">{{ block_labels[b]['label'] }}</div>
            </td>
            {% for d in days %}
              {% set key = d ~ '_' ~ b %}
{% set u = usage.get(key, {'used':0,'capacity': block_capacity_points.get(b, 1), 'over': False}) %}
<td>
  <div class="cell {% if u.over %}over{% endif %}" id="cell_{{ key|replace('-','') }}">
    <div class="cap {% if u.over %}over{% endif %}">Ø¸Ø±ÙÛŒØª: {{ u.used }} / {{ u.capacity }}</div>
    {% set arr = schedule.get(key, []) %}
                  {% if not arr %}
                    <div class="small">â€”</div>
                  {% else %}
                    {% for mid in arr %}
  {% set info = mission_lookup.get(mid) %}
  <div class="item card" title="{{ info.title if info else ('#' ~ mid) }}">
    <div class="card-main">
      {# Ú†ÛŒÙ¾ Ø¯Ø³ØªÙ‡ #}
      {% set cat = (info.category if info else 'unknown') %}
      {% set cat_class = 'mcat-' ~ ('adm' if cat=='administrative' else 'desk' if cat=='desk' else 'field' if cat=='field' else 'unk') %}
      <span class="mcat {{ cat_class }}">
        {{ 'Ø§Ø¯Ø§Ø±ÛŒ' if cat=='administrative' else 'Ø¯ÙØªØ±ÛŒ' if cat=='desk' else 'Ù…ÛŒØ¯Ø§Ù†ÛŒ' if cat=='field' else 'Ù†Ø§Ù…Ø´Ø®Øµ' }}
      </span>

      {# Ø¹Ù†ÙˆØ§Ù† Ù…Ø£Ù…ÙˆØ±ÛŒØª #}
      <div class="card-title" style="margin-top:.15rem;">
        {{ info.title if info else ('Ù…Ø§Ù…ÙˆØ±ÛŒØª #' ~ mid) }}
      </div>

      {# Ù¾Ø±ÙˆÚ˜Ù‡ Ùˆ Ù…ÙˆØ¹Ø¯/ÙˆØ¶Ø¹ÛŒØª #}
      <div class="card-meta">
        {{ (info.project_client or 'â€”') if info else 'â€”' }} â€” {{ (info.project_goal or 'â€”') if info else 'â€”' }}
      </div>
      <div class="card-meta">
       Ù…ÙˆØ¹Ø¯: {{ fmt_jalali(info.due_date) if (info and info.due_date) else 'â€”' | to_persian_number }}

        Â· ÙˆØ¶Ø¹ÛŒØª: {{ (info.status_label or info.status) if info else 'â€”' }}
      </div>
    </div>
    <div class="card-actions">
      <a class="btn" href="/razmkar/{{ mid }}" target="_blank" rel="noopener" title="Ø¨Ø§Ø² Ú©Ø±Ø¯Ù†">â†—</a>
      <button class="btn" onclick="unassign('{{ d }}','{{ b }}', {{ mid }})" title="Ø­Ø°Ù Ø§Ø² Ø¨Ù„ÙˆÚ©">Ã—</button>
      <button class="btn" onclick="openMove('{{ d }}','{{ b }}', {{ mid }})" title="Ø§Ù†ØªÙ‚Ø§Ù„">â†”ï¸</button>

    </div>
  </div>
{% endfor %}

                  {% endif %}
                  <div class="row-actions" style="margin-top:.25rem;">
                    <button class="btn" onclick="openAdd('{{ d }}','{{ b }}')">+ Ø§ÙØ²ÙˆØ¯Ù†</button>
                  </div>
                </div>
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</div>

<!-- Ù…Ø¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† -->
<div id="addModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.2); align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:10px; padding:1rem; width:820px; max-width:95vw; max-height:92vh; overflow:auto;">
    <h3 style="margin-top:0;">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø£Ù…ÙˆØ±ÛŒØª Ø¨Ù‡ <span id="addTarget"></span></h3>
    <div style="display:flex; gap:.5rem; align-items:center; margin:.6rem 0; flex-wrap:wrap;">
      <input type="text" id="queryBox" class="textbox" placeholder="Ø¬Ø³ØªØ¬Ùˆ (ID/Ø¹Ù†ÙˆØ§Ù†/Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ/Ù‡Ø¯Ù Ù¾Ø±ÙˆÚ˜Ù‡)" onkeydown="if(event.key==='Enter'){reloadPool();}">
      <select id="categorySel" class="select">
        <option value="all" {% if category=='all' %}selected{% endif %}>Ù‡Ù…Ù‡</option>
        <option value="administrative" {% if category=='administrative' %}selected{% endif %}>Ø§Ø¯Ø§Ø±ÛŒ</option>
        <option value="field" {% if category=='field' %}selected{% endif %}>Ù…ÛŒØ¯Ø§Ù†ÛŒ</option>
        <option value="desk" {% if category=='desk' %}selected{% endif %}>Ø¯ÙØªØ±ÛŒ</option>
      </select>
      <label class="small" style="display:flex; align-items:center; gap:.35rem;">
        <input type="checkbox" id="excludeDone" checked> ÙÙ‚Ø· Ù†Ø§ØªÙ…Ø§Ù…
      </label>
      <button class="btn" onclick="reloadPool()">Ø¬Ø³ØªØ¬Ùˆ</button>
    </div>
    <div id="poolTable" style="border:1px solid #eee; border-radius:8px; padding:.5rem;">
      <div class="small">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>
    </div>
    <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.8rem;">
      <button class="btn" onclick="closeAdd()">Ø¨Ø³ØªÙ†</button>
    </div>
  </div>
</div>

<!-- Ù…Ø¯Ø§Ù„ Ø§Ù†ØªÙ‚Ø§Ù„ -->
<div id="moveModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.2); align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:10px; padding:1rem; width:520px; max-width:90vw;">
    <h3 style="margin-top:0;">Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ø£Ù…ÙˆØ±ÛŒØª <span id="moveMid"></span></h3>
    <div class="small" style="margin:.25rem 0;">Ø§Ø²: <span id="moveSrc"></span></div>
    <div style="display:flex; gap:.5rem; align-items:center; margin:.6rem 0; flex-wrap:wrap;">
      <label>Ø±ÙˆØ² Ù…Ù‚ØµØ¯:
        <select id="moveDateSel" class="select"></select>
      </label>
      <label>Ø¨Ù„ÙˆÚ© Ù…Ù‚ØµØ¯:
        <select id="moveBlockSel" class="select"></select>
      </label>
      <button class="btn" onclick="doMove()">Ø§Ù†ØªÙ‚Ø§Ù„</button>
    </div>
    <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.8rem;">
      <button class="btn" onclick="closeMove()">Ø¨Ø³ØªÙ†</button>
    </div>
  </div>
</div>

<script>
  const CAT_LABELS = { field:'Ù…ÛŒØ¯Ø§Ù†ÛŒ', administrative:'Ø§Ø¯Ø§Ø±ÛŒ', desk:'Ø¯ÙØªØ±ÛŒ', unknown:'Ù†Ø§Ù…Ø´Ø®Øµ' };
  const CAT_CLASS  = { field:'mcat-field', administrative:'mcat-adm', desk:'mcat-desk', unknown:'mcat-unk' };

  let TARGET_DATE = null;
  let TARGET_BLOCK = null;

  function openAdd(d, b){
    TARGET_DATE = d;
    TARGET_BLOCK = b;
    document.getElementById('addTarget').textContent = `${d} Â· ${b}`;
    document.getElementById('addModal').style.display = 'flex';
    reloadPool();
  }
  function closeAdd(){
    document.getElementById('addModal').style.display = 'none';
  }

  function reloadPool(){
    const base = new URLSearchParams(window.location.search).get('date') || '{{ base_date }}';
    const q = document.getElementById('queryBox').value.trim();
    const cat = document.getElementById('categorySel').value || 'all';
    const excl = document.getElementById('excludeDone').checked ? '1' : '0';

    const url = new URL('/projects/planning/pool', window.location.origin);
    if (cat) url.searchParams.set('category', cat);
    if (q) url.searchParams.set('q', q);
    url.searchParams.set('exclude_done', excl);
    url.searchParams.set('limit', '200');

    fetch(url.toString())
      .then(r=>r.json())
      .then(data=>{
        if(!data.ok) throw new Error(data.error || 'failed');
        renderPool(data.items || []);
      })
      .catch(err=>{
        console.error(err);
        document.getElementById('poolTable').innerHTML = '<div class="small">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</div>';
      });
  }

  function renderPool(items){
    const box = document.getElementById('poolTable');
    if(!items.length){
      box.innerHTML = '<div class="small">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>';
      return;
    }

    const rows = items.map(it=>{
      const due = it.due_date ? it.due_date.slice(0,10) : 'â€”';
      const cat = it.category || 'unknown';
      const catLbl = CAT_LABELS[cat] || 'Ù†Ø§Ù…Ø´Ø®Øµ';
      const catClass = CAT_CLASS[cat] || 'mcat-unk';
      const proj = `${escapeHtml(it.project_client || 'â€”')} â€” ${escapeHtml(it.project_goal || 'â€”')}`;

      return `
        <tr>
          <td class="nowrap">#${it.id}</td>
          <td>
            <div class="nowrap" title="${proj}">${proj}</div>
            <div class="small">${escapeHtml(it.title || '')}</div>
          </td>
          <td><span class="mcat ${catClass}">${catLbl}</span></td>
          <td class="nowrap">${due}</td>
          <td class="nowrap">${escapeHtml(it.status_label || it.status || '')}</td>
          <td><button class="btn" onclick="assignMission(${it.id})">Ø§ÙØ²ÙˆØ¯Ù†</button></td>
        </tr>
      `;
    }).join('');

    box.innerHTML = `
      <table class="pool-table">
        <thead>
          <tr>
            <th style="width:60px;">ID</th>
            <th>Ù¾Ø±ÙˆÚ˜Ù‡ / Ù…Ø£Ù…ÙˆØ±ÛŒØª</th>
            <th style="width:90px;">Ø¯Ø³ØªÙ‡</th>
            <th style="width:100px;">Ù…ÙˆØ¹Ø¯</th>
            <th style="width:100px;">ÙˆØ¶Ø¹ÛŒØª</th>
            <th style="width:80px;">Ø¹Ù…Ù„ÛŒØ§Øª</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }
function assignMission(mid){
  if(!TARGET_DATE || !TARGET_BLOCK){ alert('Ø¨Ù„ÙˆÚ© Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡'); return; }
  fetch('/projects/planning/week/assign', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({date: TARGET_DATE, block: TARGET_BLOCK, mission_id: mid})
  })
  .then(async r=>{
    const data = await r.json().catch(()=>({}));
    if(!r.ok){
      if(data && data.error === 'over_capacity'){
        const msg = `Ø§ÛŒÙ† Ø¨Ù„ÙˆÚ© Ù¾Ø± Ø§Ø³Øª (Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒØ´Ø¯Ù‡: ${data.used} / Ø¸Ø±ÙÛŒØª: ${data.capacity}Ø› Ø§Ù…ØªÛŒØ§Ø² Ø¢ÛŒØªÙ… Ø¬Ø¯ÛŒØ¯: ${data.points_new}). Ø¢ÛŒØ§ Ø¨Ø§ ÙˆØ¬ÙˆØ¯ Ø§ÛŒÙ† Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯ØŸ`;
        if(confirm(msg)){
          return fetch('/projects/planning/week/assign', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({date: TARGET_DATE, block: TARGET_BLOCK, mission_id: mid, force: true})
          }).then(rr=>rr.json());
        } else {
          throw new Error('Ø§Ù†ØµØ±Ø§Ù Ú©Ø§Ø±Ø¨Ø±');
        }
      }
      throw new Error(data.message || data.error || 'failed');
    }
    return data;
  })
  .then(res=>{
    if(!res || res.ok !== true) throw new Error('failed');
    window.location.reload();
  })
  .catch(err=>{ if(err && err.message!=='Ø§Ù†ØµØ±Ø§Ù Ú©Ø§Ø±Ø¨Ø±') alert('Ø®Ø·Ø§: ' + err.message); });
}


  function unassign(d,b,mid){
    fetch('/projects/planning/week/unassign', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({date: d, block: b, mission_id: mid})
    })
    .then(r=>r.json())
    .then(res=>{
      if(!res.ok) throw new Error(res.error || 'failed');
      window.location.reload();
    })
    .catch(err=>{ alert('Ø®Ø·Ø§: ' + err.message); });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
  }
</script>
<script>
  // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³Ù„Ú©Øªâ€ŒÙ‡Ø§
  const WEEK_DAYS = {{ days|tojson }};
  const WEEK_BLOCKS = {{ blocks|tojson }};

  let MOVE_SRC_DATE = null;
  let MOVE_SRC_BLOCK = null;
  let MOVE_MID = null;

  function openMove(srcDate, srcBlock, mid){
    MOVE_SRC_DATE = srcDate;
    MOVE_SRC_BLOCK = srcBlock;
    MOVE_MID = mid;

    document.getElementById('moveMid').textContent = '#' + mid;
    document.getElementById('moveSrc').textContent = `${srcDate} Â· ${srcBlock}`;

    // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³Ù„Ú©Øªâ€ŒÙ‡Ø§
    const ds = document.getElementById('moveDateSel');
    const bs = document.getElementById('moveBlockSel');
    ds.innerHTML = WEEK_DAYS.map(d => `<option value="${d}" ${d===srcDate?'selected':''}>${d}</option>`).join('');
    bs.innerHTML = WEEK_BLOCKS.map(b => `<option value="${b}" ${b===srcBlock?'selected':''}>${b}</option>`).join('');

    document.getElementById('moveModal').style.display = 'flex';
  }

  function closeMove(){
    document.getElementById('moveModal').style.display = 'none';
  }

  function doMove(){
    const dstDate = document.getElementById('moveDateSel').value;
    const dstBlock = document.getElementById('moveBlockSel').value;

    fetch('/projects/planning/week/move', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        src_date: MOVE_SRC_DATE,
        src_block: MOVE_SRC_BLOCK,
        dst_date: dstDate,
        dst_block: dstBlock,
        mission_id: MOVE_MID
      })
    })
    .then(async r=>{
      const data = await r.json().catch(()=>({}));
      if(!r.ok){
        if(data && data.error === 'over_capacity'){
          const msg = `Ø¨Ù„ÙˆÚ© Ù…Ù‚ØµØ¯ Ù¾Ø± Ø§Ø³Øª (Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒØ´Ø¯Ù‡: ${data.used} / Ø¸Ø±ÙÛŒØª: ${data.capacity}Ø› Ø§Ù…ØªÛŒØ§Ø² Ø¢ÛŒØªÙ…: ${data.points_new}). Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ø§ Â«forceÂ» Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯ØŸ`;
          if(confirm(msg)){
            return fetch('/projects/planning/week/move', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({
                src_date: MOVE_SRC_DATE,
                src_block: MOVE_SRC_BLOCK,
                dst_date: dstDate,
                dst_block: dstBlock,
                mission_id: MOVE_MID,
                force: true
              })
            }).then(rr=>rr.json());
          } else {
            throw new Error('Ø§Ù†ØµØ±Ø§Ù Ú©Ø§Ø±Ø¨Ø±');
          }
        }
        throw new Error(data.message || data.error || 'failed');
      }
      return data;
    })
    .then(res=>{
      if(!res || res.ok !== true) throw new Error('failed');
      window.location.reload();
    })
    .catch(err=>{
      if(err && err.message!=='Ø§Ù†ØµØ±Ø§Ù Ú©Ø§Ø±Ø¨Ø±'){
        alert('Ø®Ø·Ø§: ' + err.message);
      }
    });
  }
</script>
<script>
  const DAYS_MAP = {{ days_map | tojson }};   // {"2025-08-18":"1404-05-27", ...}

  function openAdd(d, b){
  TARGET_DATE = d;
  TARGET_BLOCK = b;
  document.getElementById('addTarget').textContent = `${DAYS_MAP[d] || d} Â· ${b}`;
  document.getElementById('addModal').style.display = 'flex';
  reloadPool();
}

function openMove(srcDate, srcBlock, mid){
  MOVE_SRC_DATE = srcDate;
  MOVE_SRC_BLOCK = srcBlock;
  MOVE_MID = mid;

  document.getElementById('moveMid').textContent = '#' + mid;
  document.getElementById('moveSrc').textContent = `${DAYS_MAP[srcDate] || srcDate} Â· ${srcBlock}`;

  const ds = document.getElementById('moveDateSel');
  const bs = document.getElementById('moveBlockSel');
  ds.innerHTML = WEEK_DAYS.map(d => `<option value="${d}" ${d===srcDate?'selected':''}>${DAYS_MAP[d] || d}</option>`).join('');
  bs.innerHTML = WEEK_BLOCKS.map(b => `<option value="${b}" ${b===srcBlock?'selected':''}>${b}</option>`).join('');

  document.getElementById('moveModal').style.display = 'flex';
}

</script>
{% endblock %}
