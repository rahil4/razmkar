{% extends "base.html" %}

{% block title %}Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø§Ù…ÙˆØ±ÛŒØª{% endblock %}

{% block header %}Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø§Ù…ÙˆØ±ÛŒØª{% endblock %}

{% block content %}
  <section>
    <p class="breadcrumb" style="font-weight: bold;">
 <strong>[ {{ razmkar.project.client_name }} ]  {{ razmkar.project.goal }} :</strong>
  {% for parent in ancestors %}
    <a href="{{ url_for('razmkar.razmkar_detail', razmkar_id=parent.id) }}">{{ parent.mission }}</a> >
  {% endfor %}
  <span>{{ razmkar.mission }}</span>
</p>
    <h2>{{ razmkar.mission }}</h2>
    <p>{{ razmkar.note or "ØªÙˆØ¶ÛŒØ­ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡" }}</p>

    <div id="status-section" class="mb-3">
      <label>ÙˆØ¶Ø¹ÛŒØª:</label>
      <select id="status-select" class="form-select" data-task-id="{{ razmkar.id }}">
        <option value="pending" {{ 'selected' if razmkar.status.name == 'pending' else '' }}>Ù¾ÛŒØ´ Ù†ÙˆÛŒØ³</option>
        <option value="in_progress" {{ 'selected' if razmkar.status.name == 'in_progress' else '' }}>Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
        <option value="done" {{ 'selected' if razmkar.status.name == 'done' else '' }}>Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</option>
        <option value="cancelled" {{ 'selected' if razmkar.status.name == 'cancelled' else '' }}>Ù„ØºÙˆ</option>
      </select>
      <small id="status-message" class="text-success" style="display:none;">âœ” ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.</small>
    </div>

    {% if razmkar.due_date %}
      <p>ØªØ§Ø±ÛŒØ® Ø§Ù†Ø¬Ø§Ù…: {{ razmkar.due_date | to_jalali | to_persian_number }}</p>
    {% endif %}
    <p>Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡: {{ razmkar.created_at | time_since | to_persian_number }}</p>
    <button onclick="openEditRazmkarPopup()">âœï¸</button>
  </section>

  <hr>

  <section>
    <h3>Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù…ÙˆØ±ÛŒØª</h3>
    <ul>
      {% for log in razmkar.logs %}
        <li>
          <strong>{{ log.created_at | to_jalali_with_time | to_persian_number }}</strong> â€“
          {{ log.type.value }} â€“
          {{ log.content or "" }}
          {% if log.created_by %}(Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡: {{ log.created_by }}){% endif %}
        </li>
      {% else %}
        <li>Ù‡Ù†ÙˆØ² Ù„Ø§Ú¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</li>
      {% endfor %}
    </ul>
    <button onclick="openLogPopup()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯</button>
  </section>

  <hr>

  <section>
    <h3>Ø²ÛŒØ±Ù…Ø§Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§</h3>
    {% if razmkar.children %}
      <ul>
        {% for child in razmkar.children %}
          <li>
            <a href="{{ url_for('razmkar.razmkar_detail', razmkar_id=child.id) }}">
              {{ child.mission }} â€“ {{ child.status.value }}
            </a>
            {% if child.due_date %}
              ({{ child.due_date | to_jalali | to_persian_number }})
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>Ø²ÛŒØ±Ù…Ø§Ù…ÙˆØ±ÛŒØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
    {% endif %}
    <button onclick="openChildPopup()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ù…ÙˆØ±ÛŒØª </button>
    
  </section>


 <!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯ -->
  <div id="log-popup" class="popup-overlay" style="display:none;">
    <div class="popup">
      <h3>Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯ Ø¬Ø¯ÛŒØ¯</h3>
      <form id="log-form">
        <input type="hidden" name="razmkar_id" value="{{ razmkar.id }}">
        <textarea name="content" placeholder="Ù…Ø­ØªÙˆØ§ÛŒ Ù„Ø§Ú¯..." required></textarea><br>
        <input name="created_by" placeholder="Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡..."><br>
        <select name="type" required>
          <option value="">Ù†ÙˆØ¹ Ù„Ø§Ú¯</option>
          <option value="note">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</option>
          <option value="action">Ø§Ù‚Ø¯Ø§Ù…</option>
          <option value="followup">Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</option>
          <option value="reminder">ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ</option>
          <option value="status_change">ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª</option>
          <option value="file_upload">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„</option>
        </select><br>
        <button type="submit">Ø°Ø®ÛŒØ±Ù‡</button>
        <button type="button" onclick="closeLogPopup()">Ù„ØºÙˆ</button>
      </form>
    </div>
  </div>

  <!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø§ÙØ²ÙˆØ¯Ù† Ø²ÛŒØ±Ù…Ø§Ù…ÙˆØ±ÛŒØª -->
  <div id="child-razmkar-popup" class="popup-overlay" style="display:none;">
    <div class="popup">
      <h3>Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡</h3>
      <form id="child-razmkar-form">
        <input type="hidden" name="project_id" value="{{ razmkar.project.id }}">
        <input type="hidden" name="parent_id" value="{{ razmkar.id }}">
        <input name="mission" placeholder="Ø´Ø±Ø­ Ù…Ø§Ù…ÙˆØ±ÛŒØª" required><br>
        <textarea name="note" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª"></textarea><br>
        <input name="due_date" type="date"><br>
        <select name="status" required>
          <option value="">ÙˆØ¶Ø¹ÛŒØª Ù…Ø§Ù…ÙˆØ±ÛŒØª</option>
          <option value="pending">Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³</option>
          <option value="in_progress">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
          <option value="done">Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</option>
          <option value="cancelled">Ù„ØºÙˆ</option>
        </select><br>
        <button type="submit">Ø°Ø®ÛŒØ±Ù‡</button>
        <button type="button" onclick="closeChildPopup()">Ù„ØºÙˆ</button>
      </form>
    </div>

   

  </div>
   <!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ ÙˆÛŒØ±Ø§ÛŒØ´ Ø±Ø²Ù…Ú©Ø§Ø± -->
<div id="edit-razmkar-popup" class="popup-overlay" style="display:none;">
  <div class="popup">
    <h3>ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø§Ù…ÙˆØ±ÛŒØª</h3>
    <form id="edit-razmkar-form">
      <input type="hidden" name="razmkar_id" value="{{ razmkar.id }}">
      <input name="mission" value="{{ razmkar.mission }}" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ø§Ù…ÙˆØ±ÛŒØª" required><br>
      <textarea name="note" placeholder="ØªÙˆØ¶ÛŒØ­">{{ razmkar.note }}</textarea><br>
      <input name="due_date" type="date" value="{{ razmkar.due_date.strftime('%Y-%m-%d') if razmkar.due_date }}"><br>
      <select name="status" required>
        <option value="pending" {{ 'selected' if razmkar.status.name == 'pending' else '' }}>Ù¾ÛŒØ´â€Œ Ù†ÙˆÛŒØ³</option>
        <option value="in_progress" {{ 'selected' if razmkar.status.name == 'in_progress' else '' }}>Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
        <option value="done" {{ 'selected' if razmkar.status.name == 'done' else '' }}>Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</option>
        <option value="cancelled" {{ 'selected' if razmkar.status.name == 'cancelled' else '' }}>Ù„ØºÙˆ</option>
      </select><br>
      <button type="submit">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
      <button type="button" onclick="deleteRazmkar({{ razmkar.id }})" class="btn-danger">ğŸ—‘ Ø­Ø°Ù</button>
      <button type="button" onclick="closeEditRazmkarPopup()">Ù„ØºÙˆ</button>
    </form>
  </div>
</div>
  {% endblock %}

{% block scripts %}
  {{ super() }}
  
<script>
  function openEditRazmkarPopup() {
  document.getElementById("edit-razmkar-popup").style.display = "flex";
}

function closeEditRazmkarPopup() {
  document.getElementById("edit-razmkar-popup").style.display = "none";
}

function deleteRazmkar(id) {
  if (confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…Ø§Ù…ÙˆØ±ÛŒØª Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) {
    fetch(`/razmkar/${id}/delete`, { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        alert(data.message);
        window.location.href = "/"; // ÛŒØ§ Ù…Ø³ÛŒØ± Ù…Ù†Ø§Ø³Ø¨ Ø¯ÛŒÚ¯Ø±
      });
  }
}

function openLogPopup() {
  document.getElementById("log-popup").style.display = "flex";
}

function closeLogPopup() {
  document.getElementById("log-popup").style.display = "none";
}

function openChildPopup() {
  document.getElementById("child-razmkar-popup").style.display = "flex";
}

function closeChildPopup() {
  document.getElementById("child-razmkar-popup").style.display = "none";
}
</script>


<script>


document.getElementById('log-form').addEventListener('submit', function (e) {
  e.preventDefault();

  const formData = new FormData(this);
  const taskId = formData.get('razmkar_id');

  fetch(`/razmkar/${taskId}`, {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    alert(data.message);
    closeLogPopup();
    location.reload(); // ÛŒØ§ Ø¨Ø§ JS Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯ Ø¨Ø¯ÙˆÙ† reload Ø§Ù†Ø¬Ø§Ù… Ø¨Ø´Ù‡
  })
  .catch(error => {
    alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù„Ø§Ú¯");
    console.error(error);
  });
});
</script>



 <script>
    document.getElementById('status-select').addEventListener('change', function () {
      const status = this.value;
      const taskId = this.dataset.taskId;

      fetch(`/razmkar/${taskId}/update_status_ajax`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: status })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const msg = document.getElementById('status-message');
          msg.style.display = 'inline';
          setTimeout(() => msg.style.display = 'none', 2000);
        }
      });
    });


    document.getElementById("edit-razmkar-form").addEventListener("submit", function (e) {
  e.preventDefault();

  const formData = new FormData(this);
  const taskId = formData.get("razmkar_id");

  fetch(`/razmkar/${taskId}/edit`, {
    method: "POST",
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    closeEditRazmkarPopup();
    location.reload();
  })
  .catch(err => {
    alert("âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø§Ù…ÙˆØ±ÛŒØª");
    console.error(err);
  });
});


document.getElementById('child-razmkar-form').addEventListener('submit', function (e) {
  e.preventDefault();
  const formData = new FormData(this);

  fetch("/razmkar/create", {
    method: "POST",
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    closeChildPopup();
    location.reload();
  })
  .catch(err => {
    alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø²ÛŒØ±Ù…Ø§Ù…ÙˆØ±ÛŒØª");
    console.error(err);
  });
});


  </script>
{% endblock %}
