{% extends "base.html" %}

{% block title %}Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø§Ù…ÙˆØ±ÛŒØª{% endblock %}
{% block header %}Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø§Ù…ÙˆØ±ÛŒØª{% endblock %}

{% block content %}
  <section>




<p class="breadcrumb" style="font-weight: bold;">
  <strong>
    <a href="{{ url_for('projects.project_detail', project_id=razmkar.project.id) }}"
       style="color: #007bff; text-decoration: none;">
      [ {{ razmkar.project.client_name }} ]
    </a>
    <span style="font-weight: 400; color: #555; margin-right: 0.5rem;">
      {{ razmkar.project.goal }}
    </span>
  </strong>
  {% for parent in ancestors %}
    <a href="{{ url_for('razmkar.razmkar_detail', razmkar_id=parent.id) }}"> &gt; {{ parent.mission }}</a>
  {% endfor %}
</p>
    <h2>
      {{ razmkar.mission }}
      <button onclick="openEditRazmkarPopup()" style="background: none; border: none; cursor: pointer; font-size: 1rem; padding: 0;">âœï¸</button>
    </h2>

    <p>{{ razmkar.note or "ØªÙˆØ¶ÛŒØ­ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡" }}</p>

    <div id="status-section" class="mb-3">
      <label>ÙˆØ¶Ø¹ÛŒØª:</label>

      {% set status_color = {
        'pending': '#888',
        'in_progress': '#007bff',
        'done': 'green',
        'cancelled': 'red'
      } %}

      <select id="status-select" data-task-id="{{ razmkar.id }}"
              style="background: none; border: none; appearance: none; padding: 0.3rem; font-size: 1rem; cursor: pointer; color: {{ status_color.get(razmkar.status.name, '#333') }};">
        <option value="pending"     style="color: #888;"   {{ 'selected' if razmkar.status.name == 'pending' else '' }}>Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³</option>
        <option value="in_progress" style="color: #007bff;" {{ 'selected' if razmkar.status.name == 'in_progress' else '' }}>Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
        <option value="done"        style="color: green;"  {{ 'selected' if razmkar.status.name == 'done' else '' }}>Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</option>
        <option value="cancelled"   style="color: red;"    {{ 'selected' if razmkar.status.name == 'cancelled' else '' }}>Ù„ØºÙˆ</option>
      </select>

      <small id="status-message" class="text-success" style="display:none;">âœ” ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.</small>
    </div>

    {% if razmkar.due_date %}
      <p>ØªØ§Ø±ÛŒØ® Ø§Ù†Ø¬Ø§Ù…: {{ razmkar.due_date | to_jalali | to_persian_number }}</p>
    {% endif %}
    <p>Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡: {{ razmkar.created_at | time_since | to_persian_number }}</p>
  </section>

  <hr>

  <section style="margin-top: 2rem;">
    <h3 style="margin-bottom: 1rem; font-size: 1.2rem;">Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù…ÙˆØ±ÛŒØª</h3>

    <ul style="list-style: none; padding: 0; margin: 0;">
      {% for log in razmkar.logs %}
        <li style="padding: 0.6rem 0.3rem; margin-bottom: 0.3rem; border-bottom: 1px solid #eee; font-size: 0.95rem; color: #333;">

          <!-- ØªØ§Ø±ÛŒØ® Ùˆ Ù†ÙˆØ¹ Ù„Ø§Ú¯ -->
          <div style="font-size: 0.75rem; color: #999; margin-bottom: 0.2rem;">
            {{ log.created_at | to_jalali_with_time | to_persian_number }} â€“
            {{ log.type.value }}
            {% if log.created_by %}
              <span style="font-size: 0.7rem;">( {{ log.created_by }} )</span>
            {% endif %}
          </div>

          <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ù„Ø§Ú¯ + Ø§Ú©Ø´Ù†â€ŒÙ‡Ø§ -->
          <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
            <div style="flex: 1;">
              {{ log.content or "" }}
              {% if log.file_path %}
                <a href="{{ url_for('razmkar.download_log_file', log_id=log.id) }}"
                   title="Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù¾ÛŒÙˆØ³Øª" style="margin-right:5px; text-decoration:none;">â¬‡ï¸</a>
                <button onclick="deleteLogFile({{ log.id }})"
                        title="Ø­Ø°Ù Ù¾ÛŒÙˆØ³Øª"
                        style="background:none; border:none; cursor:pointer;">ğŸ—‘ï¸ğŸ“</button>
              {% endif %}
            </div>

            <!-- Ø¯Ú©Ù…Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ -->
            <button
              class="edit-log-btn"
              data-log-id="{{ log.id }}"
              data-content="{{ (log.content or '') | escape }}"
              data-type="{{ log.type.name if log.type else '' }}"
              data-created-by="{{ (log.created_by or '') | escape }}"
              title="ÙˆÛŒØ±Ø§ÛŒØ´ Ù„Ø§Ú¯"
              style="background: none; border: none; font-size: 1rem; cursor: pointer; color: #888;">
              âœï¸
            </button>
          </div>
        </li>
      {% else %}
        <li style="color: #888; padding: 0.8rem;">Ù‡Ù†ÙˆØ² Ù„Ø§Ú¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</li>
      {% endfor %}
    </ul>

    <div style="margin-top: 1rem;">
      <button onclick="openLogPopup()"
              style="padding: 0.4rem 1rem; border: none; border-radius: 6px; background-color: #007bff; color: white; cursor: pointer;">
        â• Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯
      </button>
    </div>
  </section>

  <hr>

  <section style="margin-top: 2rem;">
    <h3 style="margin-bottom: 1rem; font-size: 1.2rem;">Ø²ÛŒØ±Ù…Ø§Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§</h3>

    {% if razmkar.children %}
      <ul style="list-style: none; padding: 0; margin: 0;">
        {% for child in razmkar.children | reverse %}
          <li style="padding: 0.6rem 0.3rem; margin-bottom: 0.3rem; border-bottom: 1px solid #eee; font-size: 0.95rem;">
            <a href="{{ url_for('razmkar.razmkar_detail', razmkar_id=child.id) }}" style="text-decoration: none; color: #007bff;">
              {{ child.mission }}
            </a>
            <span style="font-size: 0.75rem; color: #666; margin-right: 0.5rem;">
              {{ child.status.value }}
            </span>
            {% if child.due_date %}
              <span style="font-size: 0.75rem; color: #999;">â€“ {{ child.due_date | to_jalali | to_persian_number }}</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p style="color: #777;">Ø²ÛŒØ±Ù…Ø§Ù…ÙˆØ±ÛŒØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
    {% endif %}

    <div style="margin-top: 1rem;">
      <button onclick="openChildPopup()"
              style="padding: 0.4rem 1rem; border: none; border-radius: 6px; background-color: #28a745; color: white; cursor: pointer;">
        â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ù…ÙˆØ±ÛŒØª
      </button>
    </div>
  </section>

  <!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯ -->
  <div id="log-popup" class="popup-overlay" style="display: none;">
    <div class="popup" style="width: 100%; max-width: 400px; background: #fff; padding: 1.5rem; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2);">
      <h3 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.2rem;">Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯ Ø¬Ø¯ÛŒØ¯</h3>

      <form id="log-form" enctype="multipart/form-data">
        <input type="hidden" name="razmkar_id" value="{{ razmkar.id }}">

        <label style="display: block; margin-bottom: 0.3rem;">Ù…Ø­ØªÙˆØ§ÛŒ Ù„Ø§Ú¯:</label>
        <textarea name="content" placeholder="..."
                  style="width: 100%; height: 100px; resize: vertical; padding: 0.5rem; margin-bottom: 1rem; border-radius: 5px; border: 1px solid #ccc;"></textarea>

        <label style="display: block; margin-bottom: 0.3rem;">Ù†ÙˆØ¹ Ù„Ø§Ú¯:</label>
        <select name="type" required style="width: 100%; padding: 0.4rem; margin-bottom: 1rem; border-radius: 5px; border: 1px solid #ccc;">
          <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
          <option value="note">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</option>
          <option value="action">ÙØ¹Ø§Ù„ÛŒØª</option>
          <option value="followup">Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</option>
          <option value="reminder">ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ</option>
          <option value="status_change">ØªØºÛŒØ± ÙˆØ¶Ø¹ÛŒØª</option>
          <option value="file_upload">Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„</option>
        </select>

        <label style="display: block; margin-bottom: 0.3rem;">ÙØ§ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label>
        <input type="file" name="file" style="width: 100%; margin-bottom: 1rem;">

        <label style="display: block; margin-bottom: 0.3rem;">Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡:</label>
        <input name="created_by" placeholder="..." style="width: 100%; padding: 0.4rem; margin-bottom: 1rem; border-radius: 5px; border: 1px solid #ccc;">

        <div style="display: flex; justify-content: space-between; gap: 0.5rem;">
          <button type="submit" style="flex: 1; padding: 0.5rem; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Ø°Ø®ÛŒØ±Ù‡</button>
          <button type="button" onclick="closeLogPopup()" style="flex: 1; padding: 0.5rem; background-color: #ddd; color: #333; border: none; border-radius: 5px; cursor: pointer;">Ù„ØºÙˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ ÙˆÛŒØ±Ø§ÛŒØ´ Ù„Ø§Ú¯ -->
  <div id="edit-log-popup" class="popup-overlay" style="display: none;">
    <div class="popup" style="width: 100%; max-width: 400px; background: #fff; padding: 1.5rem; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2);">
      <h3 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.2rem;">ÙˆÛŒØ±Ø§ÛŒØ´ Ù„Ø§Ú¯</h3>

      <form id="edit-log-form" enctype="multipart/form-data">
        <input type="hidden" name="log_id" id="edit-log-id">

        <label style="display: block; margin-bottom: 0.3rem;">Ù…Ø­ØªÙˆØ§:</label>
        <textarea name="content" id="edit-log-content" style="width: 100%; height: 100px; resize: vertical; padding: 0.5rem; margin-bottom: 1rem; border-radius: 5px; border: 1px solid #ccc;"></textarea>

        <label style="display: block; margin-bottom: 0.3rem;">Ù†ÙˆØ¹ Ù„Ø§Ú¯:</label>
        <select name="type" id="edit-log-type" style="width: 100%; padding: 0.4rem; margin-bottom: 1rem; border-radius: 5px; border: 1px solid #ccc;">
          <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
          <option value="note">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</option>
          <option value="action">ÙØ¹Ø§Ù„ÛŒØª</option>
          <option value="followup">Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</option>
          <option value="reminder">ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ</option>
          <option value="status_change">ØªØºÛŒØ± ÙˆØ¶Ø¹ÛŒØª</option>
          <option value="file_upload">Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„</option>
        </select>

        <label style="display: block; margin-bottom: 0.3rem;">ØªØ¹ÙˆÛŒØ¶/Ø§ÙØ²ÙˆØ¯Ù† ÙØ§ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label>
        <input type="file" name="file" style="width: 100%; margin-bottom: 1rem;">

        <label style="display: block; margin-bottom: 0.3rem;">Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡:</label>
        <input type="text" name="created_by" id="edit-log-created-by" style="width: 100%; padding: 0.4rem; margin-bottom: 1rem; border-radius: 5px; border: 1px solid #ccc;">

        <div style="display: flex; justify-content: space-between; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
          <button type="submit" style="flex: 1; min-width: 110px; padding: 0.5rem; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Ø°Ø®ÛŒØ±Ù‡</button>
          <button type="button" onclick="deleteLog()" style="flex: 1; min-width: 110px; padding: 0.5rem; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Ø­Ø°Ù</button>
          <button type="button" id="delete-log-file-btn" style="flex: 1; min-width: 140px; padding: 0.5rem; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Ø­Ø°Ù Ù¾ÛŒÙˆØ³Øª</button>
          <button type="button" onclick="closeEditLogPopup()" style="flex: 1; min-width: 110px; padding: 0.5rem; background-color: #ddd; color: #333; border: none; border-radius: 5px; cursor: pointer;">Ù„ØºÙˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø§ÙØ²ÙˆØ¯Ù† Ø²ÛŒØ±Ù…Ø§Ù…ÙˆØ±ÛŒØª -->
  <div id="child-razmkar-popup" class="popup-overlay" style="display: none;">
    <div class="popup" style="width: 100%; max-width: 400px; background: #fff; padding: 1.5rem; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2);">
      <h3 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.2rem;">Ø§ÙØ²ÙˆØ¯Ù† Ø²ÛŒØ±Ù…Ø§Ù…ÙˆØ±ÛŒØª</h3>

      <form id="child-razmkar-form">
        <input type="hidden" name="project_id" value="{{ razmkar.project.id }}">
        <input type="hidden" name="parent_id" value="{{ razmkar.id }}">

        <label style="display: block; margin-bottom: 0.3rem;">Ø´Ø±Ø­ Ù…Ø§Ù…ÙˆØ±ÛŒØª:</label>
        <input name="mission" placeholder="..." required style="width: 100%; padding: 0.5rem; margin-bottom: 1rem; border-radius: 5px; border: 1px solid #ccc;">

        <label style="display: block; margin-bottom: 0.3rem;">ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
        <textarea name="note" placeholder="..." style="width: 100%; height: 80px; padding: 0.5rem; margin-bottom: 1rem; border-radius: 5px; border: 1px solid #ccc;"></textarea>

        <label style="display: block; margin-bottom: 0.3rem;">ØªØ§Ø±ÛŒØ® Ø§Ù†Ø¬Ø§Ù…:</label>
        <input name="due_date" type="date" style="width: 100%; padding: 0.5rem; margin-bottom: 1rem; border-radius: 5px; border: 1px solid #ccc;">

        <label style="display: block; margin-bottom: 0.3rem;">ÙˆØ¶Ø¹ÛŒØª:</label>
        <select name="status" required style="width: 100%; padding: 0.4rem; margin-bottom: 1.2rem; border-radius: 5px; border: 1px solid #ccc;">
          <option value="">Ø§Ù†ØªØ®Ø§Ø¨ ÙˆØ¶Ø¹ÛŒØª...</option>
          <option value="pending">Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³</option>
          <option value="in_progress">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
          <option value="done">Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</option>
          <option value="cancelled">Ù„ØºÙˆ</option>
        </select>

        <div style="display: flex; justify-content: space-between; gap: 0.5rem;">
          <button type="submit" style="flex: 1; padding: 0.5rem; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Ø°Ø®ÛŒØ±Ù‡</button>
          <button type="button" onclick="closeChildPopup()" style="flex: 1; padding: 0.5rem; background-color: #ddd; color: #333; border: none; border-radius: 5px; cursor: pointer;">Ù„ØºÙˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ ÙˆÛŒØ±Ø§ÛŒØ´ Ø±Ø²Ù…Ú©Ø§Ø± -->
  <div id="edit-razmkar-popup" class="popup-overlay" style="display: none;">
    <div class="popup" style="width: 100%; max-width: 400px; background: #fff; padding: 1.5rem; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2);">
      <h3 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.2rem;">ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø§Ù…ÙˆØ±ÛŒØª</h3>

      <form id="edit-razmkar-form">
        <input type="hidden" name="razmkar_id" value="{{ razmkar.id }}">

        <label style="display: block; margin-bottom: 0.3rem;">Ø¹Ù†ÙˆØ§Ù† Ù…Ø§Ù…ÙˆØ±ÛŒØª:</label>
        <input name="mission" value="{{ razmkar.mission }}" placeholder="..." required style="width: 100%; padding: 0.5rem; margin-bottom: 1rem; border-radius: 5px; border: 1px solid #ccc;">

        <label style="display: block; margin-bottom: 0.3rem;">ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
        <textarea name="note" placeholder="..." style="width: 100%; height: 80px; padding: 0.5rem; margin-bottom: 1rem; border-radius: 5px; border: 1px solid #ccc;">{{ razmkar.note }}</textarea>

        <label style="display: block; margin-bottom: 0.3rem;">ØªØ§Ø±ÛŒØ® Ø§Ù†Ø¬Ø§Ù…:</label>
        <input name="due_date" type="date" value="{{ razmkar.due_date.strftime('%Y-%m-%d') if razmkar.due_date }}" style="width: 100%; padding: 0.5rem; margin-bottom: 1rem; border-radius: 5px; border: 1px solid #ccc;">

        <label style="display: block; margin-bottom: 0.3rem;">ÙˆØ¶Ø¹ÛŒØª:</label>
        <select name="status" required style="width: 100%; padding: 0.4rem; margin-bottom: 1.2rem; border-radius: 5px; border: 1px solid #ccc;">
          <option value="pending"     {{ 'selected' if razmkar.status.name == 'pending' else '' }}>Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³</option>
          <option value="in_progress" {{ 'selected' if razmkar.status.name == 'in_progress' else '' }}>Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
          <option value="done"        {{ 'selected' if razmkar.status.name == 'done' else '' }}>Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</option>
          <option value="cancelled"   {{ 'selected' if razmkar.status.name == 'cancelled' else '' }}>Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
        </select>

        <div style="display: flex; justify-content: space-between; gap: 0.5rem;">
          <button type="submit" style="flex: 1; padding: 0.5rem; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Ø°Ø®ÛŒØ±Ù‡</button>
          <button type="button" onclick="deleteRazmkar({{ razmkar.id }})" style="flex: 1; padding: 0.5rem; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ—‘ Ø­Ø°Ù</button>
          <button type="button" onclick="closeEditRazmkarPopup()" style="flex: 1; padding: 0.5rem; background-color: #ddd; color: #333; border: none; border-radius: 5px; cursor: pointer;">Ù„ØºÙˆ</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}

  <script>
    function openEditRazmkarPopup(){ document.getElementById("edit-razmkar-popup").style.display = "flex"; }
    function closeEditRazmkarPopup(){ document.getElementById("edit-razmkar-popup").style.display = "none"; }
    function deleteRazmkar(id){
      if (!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…Ø§Ù…ÙˆØ±ÛŒØª Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
      fetch(`/razmkar/${id}/delete`, { method: 'POST' })
        .then(r=>r.json()).then(d=>{ alert(d.message); window.location.href = "/"; });
    }

    function openLogPopup(){ document.getElementById("log-popup").style.display = "flex"; }
    function closeLogPopup(){ document.getElementById("log-popup").style.display = "none"; }

    function openChildPopup(){ document.getElementById("child-razmkar-popup").style.display = "flex"; }
    function closeChildPopup(){ document.getElementById("child-razmkar-popup").style.display = "none"; }
  </script>

  <script>
    // Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯ (Ø¨Ø§ ÙØ§ÛŒÙ„)
    document.getElementById('log-form').addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const taskId = formData.get('razmkar_id');
      fetch(`/razmkar/${taskId}/add-log`, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
      })
      .then(res => { if(!res.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±'); return res.json(); })
      .then(data => { alert(data.message || "âœ… Ù„Ø§Ú¯ Ø«Ø¨Øª Ø´Ø¯"); closeLogPopup(); location.reload(); })
      .catch(err => { alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù„Ø§Ú¯"); console.error("Log Error:", err); });
    });

    // ÙˆÛŒØ±Ø§ÛŒØ´ Ù„Ø§Ú¯ (Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ùˆ Ù¾Ø± Ú©Ø±Ø¯Ù†)
    function openEditLogPopup(id, content, type, created_by){
      document.getElementById("edit-log-id").value = id;
      document.getElementById("edit-log-content").value = content || '';
      document.getElementById("edit-log-created-by").value = created_by || '';
      const typeSelect = document.getElementById("edit-log-type");
      typeSelect.value = (type || '').trim();
      document.getElementById("edit-log-popup").style.display = "flex";
    }
    function closeEditLogPopup(){ document.getElementById("edit-log-popup").style.display = "none"; }

    // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø±ÙˆÛŒ Ù„ÛŒØ³Øª
    document.querySelectorAll('.edit-log-btn').forEach(btn=>{
      btn.addEventListener('click', function(){
        openEditLogPopup(
          this.dataset.logId,
          this.dataset.content,
          this.dataset.type,
          this.dataset.createdBy
        );
      });
    });

    // Ø«Ø¨Øª ÙˆÛŒØ±Ø§ÛŒØ´ Ù„Ø§Ú¯ (Ø¨Ø§ ÙØ§ÛŒÙ„ Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
    document.getElementById("edit-log-form").addEventListener("submit", function (e) {
      e.preventDefault();
      const logId = document.getElementById("edit-log-id").value;
      const formData = new FormData(this);
      fetch(`/razmkar/log/${logId}/edit`, {
        method: "POST",
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
      })
      .then(res => { if(!res.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±"); return res.json(); })
      .then(data => { alert(data.message || "âœ… ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯"); closeEditLogPopup(); location.reload(); })
      .catch(err => { alert("âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ù„Ø§Ú¯"); console.error("Edit Log Error:", err); });
    });

    // Ø­Ø°Ù Ù„Ø§Ú¯
    function deleteLog(){
      const logId = document.getElementById("edit-log-id").value;
      if(!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù„Ø§Ú¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
      fetch(`/razmkar/log/${logId}/delete`, { method:"POST", headers:{ 'X-Requested-With':'XMLHttpRequest' } })
        .then(res => { if(!res.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù„Ø§Ú¯"); return res.json(); })
        .then(data => { alert(data.message || "âœ… Ù„Ø§Ú¯ Ø­Ø°Ù Ø´Ø¯"); closeEditLogPopup(); location.reload(); })
        .catch(err => { alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù„Ø§Ú¯"); console.error("Delete Log Error:", err); });
    }

    // Ø­Ø°Ù Ù¾ÛŒÙˆØ³Øª ÙØ§ÛŒÙ„
    async function deleteLogFile(logId){
      if(!confirm('Ù¾ÛŒÙˆØ³Øª Ø§ÛŒÙ† Ù„Ø§Ú¯ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
      try{
        const res = await fetch(`/razmkar/log/${logId}/delete-file`, {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        if(!res.ok){
          let msg='Ø®Ø·Ø§';
          try{ const d=await res.json(); msg=d.message||JSON.stringify(d); }
          catch{ msg=await res.text(); }
          alert('âŒ ' + msg);
          return;
        }
        const data = await res.json();
        alert(data.message || 'ğŸ—‘ï¸ Ù¾ÛŒÙˆØ³Øª Ø­Ø°Ù Ø´Ø¯');
        location.reload();
      }catch(err){
        alert('âŒ Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±/Ø´Ø¨Ú©Ù‡');
        console.error(err);
      }
    }

    // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª
    document.getElementById('status-select').addEventListener('change', function () {
      const status = this.value;
      const taskId = this.dataset.taskId;
      fetch(`/razmkar/${taskId}/update_status_ajax`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      })
      .then(r=>r.json())
      .then(d=>{
        if(d.success){
          const msg = document.getElementById('status-message');
          msg.style.display = 'inline';
          setTimeout(()=> msg.style.display='none', 2000);
        }
      });
    });

    // ÙˆÛŒØ±Ø§ÛŒØ´ Ø±Ø²Ù…Ú©Ø§Ø±
    document.getElementById("edit-razmkar-form").addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const taskId = formData.get("razmkar_id");
      fetch(`/razmkar/${taskId}/edit`, {
        method: "POST",
        headers: { 'X-Requested-With':'XMLHttpRequest' },
        body: formData
      })
      .then(res => res.json())
      .then(data => { alert(data.message); closeEditRazmkarPopup(); location.reload(); })
      .catch(err => { alert("âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø§Ù…ÙˆØ±ÛŒØª"); console.error(err); });
    });

    // Ø§ÙØ²ÙˆØ¯Ù† Ø²ÛŒØ±Ù…Ø§Ù…ÙˆØ±ÛŒØª
    document.getElementById('child-razmkar-form').addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      fetch("/razmkar/create", {
        method: "POST",
        headers: { 'X-Requested-With':'XMLHttpRequest' },
        body: formData
      })
      .then(res => res.json())
      .then(data => { alert(data.message); closeChildPopup(); location.reload(); })
      .catch(err => { alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø²ÛŒØ±Ù…Ø§Ù…ÙˆØ±ÛŒØª"); console.error(err); });
    });
  </script>
{% endblock %}
