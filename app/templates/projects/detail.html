{% extends "base.html" %}

{% block title %}Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡{% endblock %}
{% block header %}Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡{% endblock %}

{% block content %}
<section style="margin-bottom: 2rem;">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h2 style="margin: 0;">
      <span style="font-weight:600; color:#333;">[ {{ project.client_name }} ]</span>
      <span style="font-weight:400; color:#555; margin-right:0.5rem;">{{ project.goal }}</span>
    </h2>
    <button onclick="openEditPopup()" title="ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÚ˜Ù‡" style="background:none;border:none;cursor:pointer;font-size:1.2rem;">âœï¸</button>
  </div>

  <div style="margin-top: 0.5rem; color: #555;">
    <span>{{ project.created_at | time_since | to_persian_number }}</span>
    <span style="margin-right: 1rem;">{{ project.status.value }}</span>
  </div>
</section>

<hr>

<section>
  <h3>Ù…Ø§Ù…ÙˆØ±ÛŒØª Ù‡Ø§</h3>
  <ul>
    {% for razmkar in project.razmkars if razmkar.parent_id is none %}
      {% include 'razmkar/_tree.html' with context %}
    {% endfor %}
  </ul>
  <button class="button-glass" onclick="openRazmkarPopup()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ù…ÙˆØ±ÛŒØª</button>
</section>

<hr>

<section>
  <ul id="logs-list" style="font-family: monospace;">
    {% for log in project.logs | reverse %}
      <li>
        <span>
          {{ log.created_at.strftime('%Y/%m/%d - %H:%M') | to_persian_number }}
          [{{ log.type.value }}]â€ƒâ€ƒ<strong>{{ log.note | to_persian_number | highlight_tags }}</strong>
        </span>
        <button onclick="editLog({{log.id}})" title="ÙˆÛŒØ±Ø§ÛŒØ´ Ù„Ø§Ú¯" style="background:none;border:none;cursor:pointer;">âœï¸</button>
      </li>
    {% else %}
      <li>Ù‡Ù†ÙˆØ² Ù„Ø§Ú¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</li>
    {% endfor %}
  </ul>
  <button class="button-glass" onclick="openLogPopup()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯</button>
</section>

<!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ù…ÙˆØ±ÛŒØª -->
<div id="razmkar-popup" class="popup-overlay" style="display: none;">
  <div class="popup" style="width: 100%; max-width: 400px; background: #fff; padding: 1.5rem; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2);">
    <h3 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.2rem;">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø¬Ø¯ÛŒØ¯</h3>

    <form id="razmkar-form">
      <input type="hidden" name="project_id" value="{{ project.id }}">

      <label style="display:block; margin-bottom:0.3rem;">Ø´Ø±Ø­ Ù…Ø§Ù…ÙˆØ±ÛŒØª:</label>
      <input name="mission" placeholder="..." required
             style="width:100%; padding:0.5rem; margin-bottom:1rem; border-radius:5px; border:1px solid #ccc;">

      <label style="display:block; margin-bottom:0.3rem;">ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
      <textarea name="note" rows="4" placeholder="..."
                style="width:100%; height:100px; resize:vertical; padding:0.5rem; margin-bottom:1rem; border-radius:5px; border:1px solid #ccc;"></textarea>

      <label style="display:block; margin-bottom:0.3rem;">ØªØ§Ø±ÛŒØ® Ø§Ù†Ø¬Ø§Ù…:</label>
      <input name="due_date" type="date"
             style="width:100%; padding:0.5rem; margin-bottom:1rem; border-radius:5px; border:1px solid #ccc;">

      <label style="display:block; margin-bottom:0.3rem;">ÙˆØ¶Ø¹ÛŒØª:</label>
      <select name="status" required
              style="width:100%; padding:0.4rem; margin-bottom:1rem; border-radius:5px; border:1px solid #ccc;">
        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
        <option value="pending">Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³</option>
        <option value="in_progress">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
        <option value="done">Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</option>
        <option value="cancelled">Ù„ØºÙˆ</option>
      </select>

      <div style="display:flex; justify-content:space-between; gap:0.5rem;">
        <button type="submit"
                style="flex:1; padding:0.5rem; background-color:#007bff; color:#fff; border:none; border-radius:5px; cursor:pointer;">
          Ø°Ø®ÛŒØ±Ù‡
        </button>
        <button type="button" onclick="closeRazmkarPopup()"
                style="flex:1; padding:0.5rem; background-color:#ddd; color:#333; border:none; border-radius:5px; cursor:pointer;">
          Ù„ØºÙˆ
        </button>
      </div>
    </form>
  </div>
</div>


<!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯ Ù¾Ø±ÙˆÚ˜Ù‡ -->
<div id="log-popup" class="popup-overlay" style="display: none;">
  <div class="popup" style="width: 100%; max-width: 400px; background: #fff; padding: 1.5rem; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2);">
    <h3 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.2rem;">Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯ Ù¾Ø±ÙˆÚ˜Ù‡</h3>

    <form id="log-form">
      <input type="hidden" name="project_id" value="{{ project.id }}">

      <label for="note" style="display:block; margin-bottom:0.3rem;">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª:</label>
      <textarea name="note" rows="5" placeholder="..." required
                style="width:100%; padding:0.5rem; font-family:inherit; margin-bottom:1rem; border-radius:5px; border:1px solid #ccc;"></textarea>

      <label for="created_by" style="display:block; margin-bottom:0.3rem;">Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡:</label>
      <input name="created_by" placeholder="Ù†Ø§Ù… ÛŒØ§ Ø¹Ù†ÙˆØ§Ù†" value="Ø±Ø§Ù‡ÛŒÙ„"
             style="width:100%; padding:0.4rem; margin-bottom:1rem; border-radius:5px; border:1px solid #ccc;">

      <label for="type" style="display:block; margin-bottom:0.3rem;">Ù†ÙˆØ¹ Ù„Ø§Ú¯:</label>
      <select name="type" required
              style="width:100%; padding:0.4rem; margin-bottom:1rem; border-radius:5px; border:1px solid #ccc;">
        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
        <option value="note">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</option>
        <option value="action">ÙØ¹Ø§Ù„ÛŒØª</option>
        <option value="followup">Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</option>
        <option value="reminder">ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ</option>
      </select>

      <div style="display:flex; justify-content:space-between; gap:0.5rem;">
        <button type="submit"
                style="flex:1; padding:0.5rem; background-color:#007bff; color:#fff; border:none; border-radius:5px; cursor:pointer;">
          Ø°Ø®ÛŒØ±Ù‡
        </button>
        <button type="button" onclick="closeLogPopup()"
                style="flex:1; padding:0.5rem; background-color:#ddd; color:#333; border:none; border-radius:5px; cursor:pointer;">
          Ù„ØºÙˆ
        </button>
      </div>
    </form>
  </div>
</div>


<!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ ÙˆÛŒØ±Ø§ÛŒØ´ Ù„Ø§Ú¯ -->
<div id="edit-log-popup" class="popup-overlay" style="display: none;">
  <div class="popup" style="width: 100%; max-width: 400px; background: #fff; padding: 1.5rem; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2);">
    <h3 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.2rem;">ÙˆÛŒØ±Ø§ÛŒØ´ Ù„Ø§Ú¯</h3>

    <form id="edit-log-form">
      <input type="hidden" name="log_id" id="edit-log-id">

      <label style="display:block; margin-bottom:0.3rem;">ØªÙˆØ¶ÛŒØ­ Ù„Ø§Ú¯:</label>
      <textarea name="note" id="edit-log-note" placeholder="..." required
                style="width:100%; height:100px; margin-bottom:1rem; border-radius:5px; border:1px solid #ccc; padding:0.5rem;"></textarea>

      <label style="display:block; margin-bottom:0.3rem;">Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡:</label>
      <input name="created_by" id="edit-log-created-by" placeholder="..."
             style="width:100%; margin-bottom:1rem; border-radius:5px; border:1px solid #ccc; padding:0.4rem;">

      <label style="display:block; margin-bottom:0.3rem;">Ù†ÙˆØ¹ Ù„Ø§Ú¯:</label>
      <select name="type" id="edit-log-type" required
              style="width:100%; margin-bottom:1rem; border-radius:5px; border:1px solid #ccc; padding:0.4rem;">
        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
        <option value="note">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</option>
        <option value="action">ÙØ¹Ø§Ù„ÛŒØª</option>
        <option value="followup">Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</option>
        <option value="reminder">ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ</option>
      </select>

      <div style="display:flex; justify-content:space-between; gap:0.5rem;">
        <button type="submit"
                style="flex:1; padding:0.5rem; background-color:#007bff; color:#fff; border:none; border-radius:5px; cursor:pointer;">
          ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡
        </button>
        <button type="button" onclick="deleteLog()"
                style="flex:1; padding:0.5rem; background-color:#c00; color:#fff; border:none; border-radius:5px; cursor:pointer;">
          ğŸ—‘ï¸ Ø­Ø°Ù
        </button>
        <button type="button" onclick="closeEditLogPopup()"
                style="flex:1; padding:0.5rem; background-color:#ddd; color:#333; border:none; border-radius:5px; cursor:pointer;">
          Ù„ØºÙˆ
        </button>
      </div>
    </form>
  </div>
</div>


<!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÚ˜Ù‡ -->
<div id="edit-project-popup" class="popup-overlay" style="display: none;">
  <div class="popup" style="width: 100%; max-width: 400px; background: #fff; padding: 1.5rem; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2);">
    <h3 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.2rem;">ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÚ˜Ù‡</h3>

    <form id="edit-project-form">
      <input type="hidden" name="project_id" value="{{ project.id }}">

      <label style="display:block; margin-bottom:0.3rem;">Ù†Ø§Ù… Ú©Ø§Ø±ÙØ±Ù…Ø§:</label>
      <input name="client_name" value="{{ project.client_name }}"
             style="width:100%; padding:0.5rem; margin-bottom:1rem; border-radius:5px; border:1px solid #ccc;">

      <label style="display:block; margin-bottom:0.3rem;">Ù‡Ø¯Ù Ù¾Ø±ÙˆÚ˜Ù‡:</label>
      <input name="goal" value="{{ project.goal }}"
             style="width:100%; padding:0.5rem; margin-bottom:1rem; border-radius:5px; border:1px solid #ccc;">

      <label style="display:block; margin-bottom:0.3rem;">ÙˆØ¶Ø¹ÛŒØª:</label>
      <select name="status" required
              style="width:100%; padding:0.4rem; margin-bottom:1rem; border-radius:5px; border:1px solid #ccc;">
        <option value="draft"     {{ 'selected' if project.status.name == 'draft' else '' }}>Ù¾ÛŒØ´ Ù†ÙˆÛŒØ³</option>
        <option value="active"    {{ 'selected' if project.status.name == 'active' else '' }}>ÙØ¹Ø§Ù„</option>
        <option value="waiting"   {{ 'selected' if project.status.name == 'waiting' else '' }}>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</option>
        <option value="completed" {{ 'selected' if project.status.name == 'completed' else '' }}>Ø§ØªÙ…Ø§Ù…</option>
        <option value="cancelled" {{ 'selected' if project.status.name == 'cancelled' else '' }}>Ù„ØºÙˆ</option>
      </select>

      <div style="display:flex; justify-content:space-between; gap:0.5rem;">
        <button type="submit"
                style="flex:1; padding:0.5rem; background-color:#007bff; color:#fff; border:none; border-radius:5px; cursor:pointer;">
          Ø°Ø®ÛŒØ±Ù‡
        </button>
        <button type="button" onclick="closeEditPopup()"
                style="flex:1; padding:0.5rem; background-color:#ddd; color:#333; border:none; border-radius:5px; cursor:pointer;">
          Ù„ØºÙˆ
        </button>
        <button type="button" onclick="deleteProject()"
                style="flex:1; padding:0.5rem; background-color:#c00; color:#fff; border:none; border-radius:5px; cursor:pointer;">
          Ø­Ø°Ù Ù¾Ø±ÙˆÚ˜Ù‡
        </button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // ---- Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ù¾Ø§Ù¾â€ŒØ¢Ù¾
  function openRazmkarPopup(){ const el=document.getElementById('razmkar-popup'); if(el) el.style.display='flex'; }
  function closeRazmkarPopup(){ const el=document.getElementById('razmkar-popup'); if(el) el.style.display='none'; }
  function openLogPopup(){ const el=document.getElementById('log-popup'); if(el) el.style.display='flex'; }
  function closeLogPopup(){ const el=document.getElementById('log-popup'); if(el) el.style.display='none'; }
  function openEditPopup(){ const el=document.getElementById('edit-project-popup'); if(el) el.style.display='flex'; }
  function closeEditPopup(){ const el=document.getElementById('edit-project-popup'); if(el) el.style.display='none'; }
  function closeEditLogPopup(){ const el=document.getElementById('edit-log-popup'); if(el) el.style.display='none'; }

  // ---- ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ù…ÙˆØ±ÛŒØª
  (function(){
    const f = document.getElementById('razmkar-form');
    if(!f) return;
    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const formData = new FormData(f);
      try{
        const res = await fetch("/razmkar/create", { method:"POST", body:formData, headers:{'X-Requested-With':'XMLHttpRequest'} });
        if(!res.ok){
          let msg="Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡";
          try{ const data=await res.json(); msg=data.message||JSON.stringify(data); } catch{ msg=await res.text(); }
          alert("âŒ Ø®Ø·Ø§: " + msg); return;
        }
        const data = await res.json();
        alert(data.message || 'âœ… Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯');
        location.reload();
      }catch(err){ alert('âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ±'); console.error(err); }
    });
  })();

  // ---- ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯
  (function(){
    const f = document.getElementById('log-form');
    if(!f) return;
    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const formData = new FormData(f);
      try{
        const res = await fetch(`/projects/{{ project.id }}/add-log`, { method:"POST", body:formData, headers:{'X-Requested-With':'XMLHttpRequest'} });
        if(!res.ok){
          let msg="Ø®Ø·Ø§"; try{ const d=await res.json(); msg=d.message||JSON.stringify(d); } catch{ msg=await res.text(); }
          alert("âŒ " + msg); return;
        }
        const data = await res.json();
        alert(data.message || "âœ… Ù„Ø§Ú¯ Ø«Ø¨Øª Ø´Ø¯");
        location.reload();
      }catch(err){ alert("âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡"); console.error(err); }
    });
  })();

  // ---- ÙØ±Ù… ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÚ˜Ù‡
  (function(){
    const f = document.getElementById('edit-project-form');
    if(!f) return;
    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const formData = new FormData(f);
      try{
        const res = await fetch(`/projects/{{ project.id }}/edit`, { method:"POST", body:formData, headers:{'X-Requested-With':'XMLHttpRequest'} });
        if(!res.ok){
          let msg="Ø®Ø·Ø§"; try{ const d=await res.json(); msg=d.message||JSON.stringify(d); } catch{ msg=await res.text(); }
          alert("âŒ " + msg); return;
        }
        const data = await res.json();
        alert(data.message || "âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯");
        location.reload();
      }catch(err){ alert("âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ±"); console.error(err); }
    });
  })();

  // ---- Ø­Ø°Ù Ù¾Ø±ÙˆÚ˜Ù‡
  async function deleteProject(){
    if(!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
    try{
      const res = await fetch(`/projects/{{ project.id }}/delete`, { method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'} });
      if(!res.ok){
        let msg="Ø®Ø·Ø§"; try{ const d=await res.json(); msg=d.message||JSON.stringify(d); } catch{ msg=await res.text(); }
        alert("âŒ " + msg); return;
      }
      const data = await res.json();
      alert(data.message || "âœ… Ù¾Ø±ÙˆÚ˜Ù‡ Ø­Ø°Ù Ø´Ø¯");
      window.location.href = "/projects";
    }catch(err){ alert("âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ±"); }
  }

  // ---- ÙˆÛŒØ±Ø§ÛŒØ´ Ù„Ø§Ú¯ (Ù„ÙˆØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ù¾Ø§Ù¾â€ŒØ¢Ù¾)
  async function editLog(logId){
    try{
      const res = await fetch(`/projects/log/${logId}`);
      if(!res.ok){
        let msg="Ø®Ø·Ø§"; try{ const d=await res.json(); msg=d.message||JSON.stringify(d); } catch{ msg=await res.text(); }
        alert("âŒ " + msg); return;
      }
      const data = await res.json();
      document.getElementById('edit-log-id').value = logId;
      document.getElementById('edit-log-note').value = data.note || '';
      document.getElementById('edit-log-created-by').value = data.created_by || '';
      document.getElementById('edit-log-type').value = data.type || '';
      document.getElementById('edit-log-popup').style.display = 'flex';
    }catch(err){ alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù„Ø§Ú¯"); console.error(err); }
  }

  // ---- Ø«Ø¨Øª Ùˆ Ø­Ø°Ù Ù„Ø§Ú¯
  (function(){
    const f = document.getElementById('edit-log-form');
    if(!f) return;
    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const formData = new FormData(f);
      try{
        const res = await fetch(`/projects/log/${formData.get('log_id')}/edit`, { method:"POST", body:formData, headers:{'X-Requested-With':'XMLHttpRequest'} });
        if(!res.ok){
          let msg="Ø®Ø·Ø§"; try{ const d=await res.json(); msg=d.message||JSON.stringify(d); } catch{ msg=await res.text(); }
          alert("âŒ " + msg); return;
        }
        const data = await res.json();
        alert(data.message || "âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø«Ø¨Øª Ø´Ø¯");
        location.reload();
      }catch(err){ alert("âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡"); console.error(err); }
    });
  })();

  async function deleteLog(){
    const logId = document.getElementById('edit-log-id').value;
    if(!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù„Ø§Ú¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
    try{
      const res = await fetch(`/projects/log/${logId}/delete`, { method:"POST", headers:{'X-Requested-With':'XMLHttpRequest'} });
      if(!res.ok){
        let msg="Ø®Ø·Ø§"; try{ const d=await res.json(); msg=d.message||JSON.stringify(d); } catch{ msg=await res.text(); }
        alert("âŒ " + msg); return;
      }
      const data = await res.json();
      alert(data.message || "âœ… Ù„Ø§Ú¯ Ø­Ø°Ù Ø´Ø¯");
      location.reload();
    }catch(err){ alert("âŒ Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ± ÛŒØ§ Ø´Ø¨Ú©Ù‡"); }
  }
</script>
{% endblock %}
