{% extends "base.html" %}

{% block title %}Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡{% endblock %}
{% block header %}Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡{% endblock %}

{% block extra_head %}
<style>
  /* ÙÙ‚Ø· Ø§ÛŒÙ† ØµÙØ­Ù‡ */
  .p-project .status{padding:.15rem .45rem;border-radius:999px;font-size:.85rem;border:1px solid transparent}
  .p-project .st-draft{color:#777;background:#f7f7f7}
  .p-project .st-active{color:#0a6;background:#e8fff5}
  .p-project .st-waiting{color:#a60;background:#fff6e6}
  .p-project .st-completed{color:#06c;background:#eaf4ff}
  .p-project .st-cancelled{color:#b00;background:#ffecec}

  /* Ù„ÛŒØ³Øª Ù„Ø§Ú¯â€ŒÙ‡Ø§ */
  .p-project .logs{list-style:none;margin:0;padding:0}
  .p-project .logs li{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:.5rem .75rem;border-bottom:1px solid var(--line)}
  .p-project .logs li:last-child{border-bottom:0}
  .p-project .log-meta{color:var(--muted);font-size:.9em;white-space:nowrap}
  .p-project .log-note strong{font-weight:600}

  /* Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ */
  .p-project .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.18);display:none;align-items:center;justify-content:center;z-index:999}
  .p-project .modal{width:100%;max-width:420px;background:#fff;border-radius:12px;box-shadow:0 8px 26px rgba(0,0,0,.15);padding:1rem 1rem 1.1rem}
  .p-project .modal h3{margin:.2rem 0 1rem;font-size:1.1rem}
  .p-project .modal .row{margin-bottom:.75rem}
  .p-project .modal .actions{display:flex;gap:.5rem}
</style>
{% endblock %}

{% block content %}
<div class="p-project">

  <!-- Ø³Ø±Ø¨Ø±Ú¯ Ù¾Ø±ÙˆÚ˜Ù‡ -->
  <section class="mb-3">
    <div class="flex items-center justify-between wrap gap-2">
      <div class="flex items-center gap-2">
        <h2 class="h2 m-0">
          <span class="fw-600">[ {{ project.client_name }} ]</span>
          <span class="fw-400 muted">â€” {{ project.goal }}</span>
        </h2>
        <span class="status st-{{ project.status.name }}">{{ project.status.value }}</span>
      </div>
      <div class="flex items-center gap-2">
        <button class="btn" title="ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÚ˜Ù‡" onclick="openEditPopup()">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <!-- ÙØ±Ù… Ø­Ø°Ù (Ø±ÛŒØ¯Ø§ÛŒØ±Ú©Øª ØªÙ…ÛŒØ²) -->
        <form id="delete-project-form" method="post" action="{{ url_for('projects.delete_project', project_id=project.id) }}"></form>
        <button class="btn btn-danger" onclick="deleteProject()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>
    </div>
    <div class="muted mt-1">
      <span>{{ project.created_at | time_since | to_persian_number }}</span>
    </div>
  </section>

  <!-- Ù…Ø£Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§ -->
  <section class="card mb-3">
    <div class="card-body">
      <div class="flex items-center justify-between wrap gap-2 mb-1">
        <h3 class="h2 m-0">Ù…Ø§Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§</h3>
        <button class="btn btn-primary" onclick="openRazmkarPopup()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø£Ù…ÙˆØ±ÛŒØª</button>
      </div>
      <ul class="mt-1">
        {% for razmkar in project.razmkars if razmkar.parent_id is none %}
          {% include 'razmkar/_tree.html' with context %}
        {% endfor %}
      </ul>
    </div>
  </section>

  <!-- Ù„Ø§Ú¯â€ŒÙ‡Ø§ -->
  <section class="card">
    <div class="card-body">
      <div class="flex items-center justify-between wrap gap-2 mb-1">
        <h3 class="h2 m-0">Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡</h3>
        <button class="btn" onclick="openLogPopup()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯</button>
      </div>

      <ul id="logs-list" class="logs">
        {% for log in project.logs | reverse %}
          <li>
            <div class="flex items-center gap-2">
              <span class="log-meta">
                {{ log.created_at.strftime('%Y/%m/%d - %H:%M') | to_persian_number }}
                &nbsp;[{{ log.type.value }}]
              </span>
              <span class="log-note">
                <strong>{{ log.note | to_persian_number | highlight_tags }}</strong>
              </span>
            </div>
            <button class="btn btn-ghost" title="ÙˆÛŒØ±Ø§ÛŒØ´ Ù„Ø§Ú¯" onclick="editLog({{ log.id }})">âœï¸</button>
          </li>
        {% else %}
          <li class="muted">Ù‡Ù†ÙˆØ² Ù„Ø§Ú¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</li>
        {% endfor %}
      </ul>
    </div>
  </section>

  <!-- === Ù…ÙˆØ¯Ø§Ù„: Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø£Ù…ÙˆØ±ÛŒØª === -->
  <div id="razmkar-popup" class="modal-overlay">
    <div class="modal">
      <h3>Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø£Ù…ÙˆØ±ÛŒØª Ø¬Ø¯ÛŒØ¯</h3>
      <form id="razmkar-form">
        <input type="hidden" name="project_id" value="{{ project.id }}">
        <div class="row">
          <label class="block mb-1">Ø´Ø±Ø­ Ù…Ø£Ù…ÙˆØ±ÛŒØª:</label>
          <input name="mission" class="input" placeholder="..." required>
        </div>
        <div class="row">
          <label class="block mb-1">ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
          <textarea name="note" class="textarea" rows="4" placeholder="..."></textarea>
        </div>
        <div class="row">
          <label class="block mb-1">ØªØ§Ø±ÛŒØ® Ø§Ù†Ø¬Ø§Ù…:</label>
          <input name="due_date" class="input" type="date">
        </div>
        <div class="row">
          <label class="block mb-1">ÙˆØ¶Ø¹ÛŒØª:</label>
          <select name="status" class="select" required>
            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
            <option value="pending">Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³</option>
            <option value="in_progress">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
            <option value="done">Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</option>
            <option value="cancelled">Ù„ØºÙˆ</option>
          </select>
        </div>
        <div class="actions">
          <button type="submit" class="btn btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
          <button type="button" class="btn" onclick="closeRazmkarPopup()">Ù„ØºÙˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- === Ù…ÙˆØ¯Ø§Ù„: Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯ === -->
  <div id="log-popup" class="modal-overlay">
    <div class="modal">
      <h3>Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯ Ù¾Ø±ÙˆÚ˜Ù‡</h3>
      <form id="log-form">
        <input type="hidden" name="project_id" value="{{ project.id }}">
        <div class="row">
          <label class="block mb-1">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª:</label>
          <textarea name="note" class="textarea" rows="5" placeholder="..." required></textarea>
        </div>
        <div class="row">
          <label class="block mb-1">Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡:</label>
          <input name="created_by" class="input" placeholder="Ù†Ø§Ù… ÛŒØ§ Ø¹Ù†ÙˆØ§Ù†" value="Ø±Ø§Ù‡ÛŒÙ„">
        </div>
        <div class="row">
          <label class="block mb-1">Ù†ÙˆØ¹ Ù„Ø§Ú¯:</label>
          <select name="type" class="select" required>
            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
            <option value="note">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</option>
            <option value="action">ÙØ¹Ø§Ù„ÛŒØª</option>
            <option value="followup">Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</option>
            <option value="reminder">ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ</option>
          </select>
        </div>
        <div class="actions">
          <button type="submit" class="btn btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
          <button type="button" class="btn" onclick="closeLogPopup()">Ù„ØºÙˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- === Ù…ÙˆØ¯Ø§Ù„: ÙˆÛŒØ±Ø§ÛŒØ´ Ù„Ø§Ú¯ === -->
  <div id="edit-log-popup" class="modal-overlay">
    <div class="modal">
      <h3>ÙˆÛŒØ±Ø§ÛŒØ´ Ù„Ø§Ú¯</h3>
      <form id="edit-log-form">
        <input type="hidden" name="log_id" id="edit-log-id">
        <div class="row">
          <label class="block mb-1">ØªÙˆØ¶ÛŒØ­ Ù„Ø§Ú¯:</label>
          <textarea name="note" id="edit-log-note" class="textarea" rows="4" required></textarea>
        </div>
        <div class="row">
          <label class="block mb-1">Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡:</label>
          <input name="created_by" id="edit-log-created-by" class="input" placeholder="...">
        </div>
        <div class="row">
          <label class="block mb-1">Ù†ÙˆØ¹ Ù„Ø§Ú¯:</label>
          <select name="type" id="edit-log-type" class="select" required>
            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
            <option value="note">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</option>
            <option value="action">ÙØ¹Ø§Ù„ÛŒØª</option>
            <option value="followup">Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</option>
            <option value="reminder">ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ</option>
          </select>
        </div>
        <div class="actions">
          <button type="submit" class="btn btn-primary">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
          <button type="button" class="btn btn-danger" onclick="deleteLog()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          <button type="button" class="btn" onclick="closeEditLogPopup()">Ù„ØºÙˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- === Ù…ÙˆØ¯Ø§Ù„: ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÚ˜Ù‡ === -->
  <div id="edit-project-popup" class="modal-overlay">
    <div class="modal">
      <h3>ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÚ˜Ù‡</h3>
      <form id="edit-project-form">
        <input type="hidden" name="project_id" value="{{ project.id }}">
        <div class="row">
          <label class="block mb-1">Ù†Ø§Ù… Ú©Ø§Ø±ÙØ±Ù…Ø§:</label>
          <input name="client_name" class="input" value="{{ project.client_name }}">
        </div>
        <div class="row">
          <label class="block mb-1">Ù‡Ø¯Ù Ù¾Ø±ÙˆÚ˜Ù‡:</label>
          <input name="goal" class="input" value="{{ project.goal }}">
        </div>
        <div class="row">
          <label class="block mb-1">ÙˆØ¶Ø¹ÛŒØª:</label>
          <select name="status" class="select" required>
            <option value="draft"     {{ 'selected' if project.status.name == 'draft' else '' }}>Ù¾ÛŒØ´ Ù†ÙˆÛŒØ³</option>
            <option value="active"    {{ 'selected' if project.status.name == 'active' else '' }}>ÙØ¹Ø§Ù„</option>
            <option value="waiting"   {{ 'selected' if project.status.name == 'waiting' else '' }}>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</option>
            <option value="completed" {{ 'selected' if project.status.name == 'completed' else '' }}>Ø§ØªÙ…Ø§Ù…</option>
            <option value="cancelled" {{ 'selected' if project.status.name == 'cancelled' else '' }}>Ù„ØºÙˆ</option>
          </select>
        </div>
        <div class="actions">
          <button type="submit" class="btn btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
          <button type="button" class="btn" onclick="closeEditPopup()">Ù„ØºÙˆ</button>
        </div>
      </form>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // helper Ø§Ø² base.html
  const CSRF = (window.getCsrfToken && window.getCsrfToken()) || '';

  // Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„
  function openRazmkarPopup(){ document.getElementById('razmkar-popup').style.display='flex'; }
  function closeRazmkarPopup(){ document.getElementById('razmkar-popup').style.display='none'; }
  function openLogPopup(){ document.getElementById('log-popup').style.display='flex'; }
  function closeLogPopup(){ document.getElementById('log-popup').style.display='none'; }
  function openEditPopup(){ document.getElementById('edit-project-popup').style.display='flex'; }
  function closeEditPopup(){ document.getElementById('edit-project-popup').style.display='none'; }
  function closeEditLogPopup(){ document.getElementById('edit-log-popup').style.display='none'; }

  // Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø£Ù…ÙˆØ±ÛŒØª
  (function(){
    const f = document.getElementById('razmkar-form');
    if(!f) return;
    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const formData = new FormData(f);
      try{
        const res = await fetch("/razmkar/create", {
          method:"POST",
          body:formData,
          headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':CSRF}
        });
        if(!res.ok){
          let msg="Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡";
          try{ const data=await res.json(); msg=data.message||JSON.stringify(data); } catch{ msg=await res.text(); }
          alert("âŒ " + msg); return;
        }
        const data = await res.json();
        alert(data.message || 'âœ… Ù…Ø£Ù…ÙˆØ±ÛŒØª Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯');
        location.reload();
      }catch(err){ alert('âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡/Ø³Ø±ÙˆØ±'); console.error(err); }
    });
  })();

  // Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯
  (function(){
    const f = document.getElementById('log-form');
    if(!f) return;
    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const formData = new FormData(f);
      try{
        const res = await fetch(`/projects/{{ project.id }}/add-log`, {
          method:"POST",
          body:formData,
          headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':CSRF}
        });
        if(!res.ok){
          let msg="Ø®Ø·Ø§"; try{ const d=await res.json(); msg=d.message||JSON.stringify(d); } catch{ msg=await res.text(); }
          alert("âŒ " + msg); return;
        }
        const data = await res.json();
        alert(data.message || "âœ… Ù„Ø§Ú¯ Ø«Ø¨Øª Ø´Ø¯");
        location.reload();
      }catch(err){ alert("âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡"); console.error(err); }
    });
  })();

  // ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÚ˜Ù‡
  (function(){
    const f = document.getElementById('edit-project-form');
    if(!f) return;
    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const formData = new FormData(f);
      try{
        const res = await fetch(`/projects/{{ project.id }}/edit`, {
          method:"POST",
          body:formData,
          headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':CSRF}
        });
        if(!res.ok){
          let msg="Ø®Ø·Ø§"; try{ const d=await res.json(); msg=d.message||JSON.stringify(d); } catch{ msg=await res.text(); }
          alert("âŒ " + msg); return;
        }
        const data = await res.json();
        alert(data.message || "âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯");
        location.reload();
      }catch(err){ alert("âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡/Ø³Ø±ÙˆØ±"); console.error(err); }
    });
  })();

  // Ø­Ø°Ù Ù¾Ø±ÙˆÚ˜Ù‡ (Ø¨Ø§ ÙØ±Ù… POST Ùˆ Ø±ÛŒØ¯Ø§ÛŒØ±Ú©Øª Ø³Ø±ÙˆØ±)
  function deleteProject(){
    if(!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
    document.getElementById('delete-project-form').submit();
  }

  // Ù„ÙˆØ¯ Ø¯Ø§Ø¯Ù‡ Ù„Ø§Ú¯ Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´
  async function editLog(logId){
    try{
      const res = await fetch(`/projects/log/${logId}`);
      if(!res.ok){
        let msg="Ø®Ø·Ø§"; try{ const d=await res.json(); msg=d.message||JSON.stringify(d); } catch{ msg=await res.text(); }
        alert("âŒ " + msg); return;
      }
      const data = await res.json();
      document.getElementById('edit-log-id').value = logId;
      document.getElementById('edit-log-note').value = data.note || '';
      document.getElementById('edit-log-created-by').value = data.created_by || '';
      document.getElementById('edit-log-type').value = data.type || '';
      document.getElementById('edit-log-popup').style.display = 'flex';
    }catch(err){ alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù„Ø§Ú¯"); console.error(err); }
  }

  // Ø«Ø¨Øª Ùˆ Ø­Ø°Ù Ù„Ø§Ú¯
  (function(){
    const f = document.getElementById('edit-log-form');
    if(!f) return;
    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const formData = new FormData(f);
      try{
        const res = await fetch(`/projects/log/${formData.get('log_id')}/edit`, {
          method:"POST",
          body:formData,
          headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':CSRF}
        });
        if(!res.ok){
          let msg="Ø®Ø·Ø§"; try{ const d=await res.json(); msg=d.message||JSON.stringify(d); } catch{ msg=await res.text(); }
          alert("âŒ " + msg); return;
        }
        const data = await res.json();
        alert(data.message || "âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø«Ø¨Øª Ø´Ø¯");
        location.reload();
      }catch(err){ alert("âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡"); console.error(err); }
    });
  })();

  async function deleteLog(){
    const logId = document.getElementById('edit-log-id').value;
    if(!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù„Ø§Ú¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
    try{
      const res = await fetch(`/projects/log/${logId}/delete`, {
        method:"POST",
        headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':CSRF}
      });
      if(!res.ok){
        let msg="Ø®Ø·Ø§"; try{ const d=await res.json(); msg=d.message||JSON.stringify(d); } catch{ msg=await res.text(); }
        alert("âŒ " + msg); return;
      }
      const data = await res.json();
      alert(data.message || "âœ… Ù„Ø§Ú¯ Ø­Ø°Ù Ø´Ø¯");
      location.reload();
    }catch(err){ alert("âŒ Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±/Ø´Ø¨Ú©Ù‡"); }
  }
</script>
{% endblock %}
