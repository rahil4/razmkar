{% extends "base.html" %}

{% block title %}Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡{% endblock %}

{% block header %}Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡{% endblock %}

{% block content %}
  <section>
    <h2>{{ project.client_name }} - {{ project.goal }}</h2>
    <p>{{ project.status.value }}</p>
    <span>{{ project.created_at | time_since | to_persian_number }}</span>
    <br>
    <button onclick="openEditPopup()">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÚ˜Ù‡</button>
  </section>

  <hr>

  <section>
    <h3>Ø±Ø²Ù…Ú©Ø§Ø±Ù‡Ø§</h3>
    <ul>
      {% for razmkar in project.razmkars if razmkar.parent_id is none %}
        {% include 'razmkar/_tree.html' with context %}
      {% endfor %}
    </ul>
    <button onclick="openRazmkarPopup()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ù…ÙˆØ±ÛŒØª</button>
  </section>

  <hr>

  <section>
    <h3>Ù„Ø§Ú¯â€ŒÙ‡Ø§</h3>
    <ul id="logs-list">
      {% for log in project.logs %}
        <li>
          <strong>{{ log.created_at | to_jalali_with_time }}</strong> â€“
          {{ log.type }} â€“
          {{ log.note }} (Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡: {{ log.created_by }})
        </li>
      {% else %}
        <li>Ù‡Ù†ÙˆØ² Ù„Ø§Ú¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</li>
      {% endfor %}
    </ul>
    <button onclick="openLogPopup()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯</button>
  </section>

  <!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ù…ÙˆØ±ÛŒØª -->
  <div id="razmkar-popup" class="popup-overlay" style="display:none;">
    <div class="popup">
      <h3>Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø¬Ø¯ÛŒØ¯</h3>
      <form id="razmkar-form">
        <input type="hidden" name="project_id" value="{{ project.id }}">
        <input name="mission" placeholder="Ø´Ø±Ø­ Ù…Ø§Ù…ÙˆØ±ÛŒØª" required><br>
        <textarea name="note" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª"></textarea><br>
        <input name="due_date" type="date"><br>
        <select name="status" required>
          <option value="">ÙˆØ¶Ø¹ÛŒØª Ù…Ø§Ù…ÙˆØ±ÛŒØª</option>
          <option value="pending">Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³</option>
          <option value="in_progress">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
          <option value="done">Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</option>
          <option value="cancelled">Ù„ØºÙˆ</option>
        </select><br>
        <button type="submit">Ø°Ø®ÛŒØ±Ù‡</button>
        <button type="button" onclick="closeRazmkarPopup()">Ù„ØºÙˆ</button>
      </form>
    </div>
  </div>

  <!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÚ˜Ù‡ -->
  <div id="edit-project-popup" class="popup-overlay" style="display:none;">
    <div class="popup">
      <h3>ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÚ˜Ù‡</h3>
      <form id="edit-project-form">
        <input type="hidden" name="project_id" value="{{ project.id }}">
        <input name="client_name" value="{{ project.client_name }}" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±ÙØ±Ù…Ø§" required><br>
        <input name="goal" value="{{ project.goal }}" placeholder="Ù‡Ø¯Ù Ù¾Ø±ÙˆÚ˜Ù‡" required><br>
        <select name="status" required>
          <option value="draft" {% if project.status.name == 'draft' %}selected{% endif %}>Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³</option>
          <option value="active" {% if project.status.name == 'active' %}selected{% endif %}>ÙØ¹Ø§Ù„</option>
          <option value="waiting" {% if project.status.name == 'waiting' %}selected{% endif %}>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</option>
          <option value="completed" {% if project.status.name == 'completed' %}selected{% endif %}>Ø§ØªÙ…Ø§Ù…</option>
          <option value="cancelled" {% if project.status.name == 'cancelled' %}selected{% endif %}>Ù„ØºÙˆ</option>
        </select><br>
        <button type="submit">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
        <button type="button" onclick="deleteProject()" style="background:#c00;color:#fff;">ğŸ—‘ï¸ Ø­Ø°Ù Ù¾Ø±ÙˆÚ˜Ù‡</button>
        <button type="button" onclick="closeEditPopup()">Ù„ØºÙˆ</button>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  function openRazmkarPopup() {
    document.getElementById('razmkar-popup').style.display = 'flex';
  }
  function closeRazmkarPopup() {
    document.getElementById('razmkar-popup').style.display = 'none';
  }
  document.getElementById('razmkar-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    try {
      const response = await fetch("/razmkar/create", {
        method: "POST",
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      if (response.ok) {
        alert('âœ… Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯');
        location.reload();
      } else {
        const text = await response.text();
        alert('âŒ Ø®Ø·Ø§: ' + text);
      }
    } catch (err) {
      alert('âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ±');
      console.error(err);
    }
  });

  function openEditPopup() {
    document.getElementById('edit-project-popup').style.display = 'flex';
  }
  function closeEditPopup() {
    document.getElementById('edit-project-popup').style.display = 'none';
  }
  document.getElementById('edit-project-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    try {
      const response = await fetch(`/projects/{{ project.id }}/edit`, {
        method: "POST",
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      if (response.ok) {
        alert("âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯");
        location.reload();
      } else {
        const error = await response.text();
        alert("âŒ Ø®Ø·Ø§: " + error);
      }
    } catch (err) {
      alert("âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ±");
      console.error(err);
    }
  });

  async function deleteProject() {
    if (!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
    try {
      const response = await fetch(`/projects/{{ project.id }}/delete`, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      if (response.ok) {
        alert("âœ… Ù¾Ø±ÙˆÚ˜Ù‡ Ø­Ø°Ù Ø´Ø¯");
        window.location.href = "/projects";
      } else {
        const text = await response.text();
        alert("âŒ Ø®Ø·Ø§: " + text);
      }
    } catch (err) {
      alert("âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ±");
    }
  }
</script>
{% endblock %}
