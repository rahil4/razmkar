{% extends "base.html" %}

{% block title %}Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡{% endblock %}

{% block header %}Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡{% endblock %}

{% block content %}
<section style="margin-bottom: 2rem;">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h2 style="margin: 0;">
      {{ project.client_name }} - {{ project.goal }}
    </h2>
    <button onclick="openEditPopup()" title="ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÚ˜Ù‡" style="background: none; border: none; cursor: pointer; font-size: 1.2rem;">
  âœï¸
</button>

  </div>

  <div style="margin-top: 0.5rem; color: #555;">
    <span>{{ project.created_at | time_since | to_persian_number }}</span> <span style="margin-right: 1rem;">{{ project.status.value }}</span>
  </div>
</section>


  <hr>

  <section>
    <h3>Ù…Ø§Ù…ÙˆØ±ÛŒØª Ù‡Ø§</h3>
    <ul>
      {% for razmkar in project.razmkars if razmkar.parent_id is none %}
        {% include 'razmkar/_tree.html' with context %}
      {% endfor %}
    </ul>
   <button class="button-glass" onclick="openRazmkarPopup()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ù…ÙˆØ±ÛŒØª</button>

  </section>

  <hr>

<section>
  
  <ul id="logs-list" style="font-family: monospace;">
  {% for log in project.logs | reverse %}
    <li>
      <span>
        {{ log.created_at.strftime('%Y/%m/%d - %H:%M') | to_persian_number }}
        [{{ log.type.value }}]â€ƒâ€ƒ<strong>{{ log.note | to_persian_number | highlight_tags }}</strong>

      </span>
      <button onclick="editLog({{log.id}})" title="ÙˆÛŒØ±Ø§ÛŒØ´ Ù„Ø§Ú¯" style="background: none; border: none; cursor: pointer;">âœï¸</button>
    </li>
  {% else %}
    <li>Ù‡Ù†ÙˆØ² Ù„Ø§Ú¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</li>
  {% endfor %}
</ul>
<button class="button-glass" onclick="openLogPopup()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯</button>

</section>

  <!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ù…ÙˆØ±ÛŒØª -->
<div id="razmkar-popup" class="popup-overlay" style="display:none;">
  <div class="popup">
    <h3>Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø¬Ø¯ÛŒØ¯</h3>
    <form id="razmkar-form" style="display: flex; flex-direction: column; gap: 0.8rem;">
      <input type="hidden" name="project_id" value="{{ project.id }}">

      <input name="mission" placeholder="Ø´Ø±Ø­ Ù…Ø§Ù…ÙˆØ±ÛŒØª" required 
             style="padding: 0.6rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 8px;">

      <textarea name="note" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª" rows="4"
                style="padding: 0.6rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 8px; resize: vertical;"></textarea>

      <input name="due_date" type="date"
             style="padding: 0.6rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 8px;">

      <select name="status" required
              style="padding: 0.6rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 8px;">
        <option value="">ÙˆØ¶Ø¹ÛŒØª Ù…Ø§Ù…ÙˆØ±ÛŒØª</option>
        <option value="pending">Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³</option>
        <option value="in_progress">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
        <option value="done">Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</option>
        <option value="cancelled">Ù„ØºÙˆ</option>
      </select>

      <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 0.5rem;">
        <button type="submit" class="button-glass">Ø°Ø®ÛŒØ±Ù‡</button>
        <button type="button" onclick="closeRazmkarPopup()" class="button-glass">Ù„ØºÙˆ</button>
      </div>
    </form>
  </div>
</div>

  <!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯ Ù¾Ø±ÙˆÚ˜Ù‡ -->
 <div id="log-popup" class="popup-overlay" style="display:none;">
  <div class="popup">
    <h3 style="margin-top: 0;">Ø§ÙØ²ÙˆØ¯Ù† Ù„Ø§Ú¯ Ù¾Ø±ÙˆÚ˜Ù‡</h3>
    <form id="log-form">
      <input type="hidden" name="project_id" value="{{ project.id }}">

      <label for="note">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label><br>
      <textarea name="note" rows="5" style="width: 100%; padding: 0.5rem; font-family: inherit;" required></textarea><br><br>

      <label for="created_by">Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡</label><br>
      <input name="created_by" placeholder="Ù†Ø§Ù… ÛŒØ§ Ø¹Ù†ÙˆØ§Ù†" value="Ø±Ø§Ù‡ÛŒÙ„" style="width: 100%; padding: 0.4rem;"><br><br>

      <label for="type">Ù†ÙˆØ¹ Ù„Ø§Ú¯</label><br>
      <select name="type" required style="width: 100%; padding: 0.4rem;">
        <option value="">Ù†ÙˆØ¹ Ù„Ø§Ú¯</option>
        <option value="note">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</option>
        <option value="action">ÙØ¹Ø§Ù„ÛŒØª</option>
        <option value="followup">Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</option>
        <option value="reminder">ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ</option>
      </select><br><br>

      <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
        <button type="submit" style="padding: 0.4rem 1rem;">Ø°Ø®ÛŒØ±Ù‡</button>
        <button type="button" onclick="closeLogPopup()" style="padding: 0.4rem 1rem;">Ù„ØºÙˆ</button>
      </div>
    </form>
  </div>
</div>




  <!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ ÙˆÛŒØ±Ø§ÛŒØ´ Ù„Ø§Ú¯ -->
<div id="edit-log-popup" class="popup-overlay" style="display:none;">
  <div class="popup">
    <h3>ÙˆÛŒØ±Ø§ÛŒØ´ Ù„Ø§Ú¯</h3>
    <form id="edit-log-form">
      <input type="hidden" name="log_id" id="edit-log-id">

      <textarea name="note" id="edit-log-note" placeholder="ØªÙˆØ¶ÛŒØ­ Ù„Ø§Ú¯..." required style="width: 100%; height: 100px; margin-bottom: 1rem;"></textarea>

      <input name="created_by" id="edit-log-created-by" placeholder="Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡" style="width: 100%; margin-bottom: 1rem;">

      <select name="type" id="edit-log-type" required style="width: 100%; margin-bottom: 1rem;">
        <option value="">Ù†ÙˆØ¹ Ù„Ø§Ú¯</option>
        <option value="note">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</option>
        <option value="action">ÙØ¹Ø§Ù„ÛŒØª</option>
        <option value="followup">Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</option>
        <option value="reminder">ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ</option>
      </select>

      <div style="display: flex; justify-content: space-between; gap: 0.5rem;">
        <button type="submit" style="flex: 1;">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
        <button type="button" onclick="deleteLog()" style="flex: 1; background:#c00; color:#fff;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        <button type="button" onclick="closeEditLogPopup()" style="flex: 1;">Ù„ØºÙˆ</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  function openRazmkarPopup() {
    document.getElementById('razmkar-popup').style.display = 'flex';
  }
  function closeRazmkarPopup() {
    document.getElementById('razmkar-popup').style.display = 'none';
  }

  document.getElementById('razmkar-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    try {
      const response = await fetch("/razmkar/create", {
        method: "POST",
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      if (response.ok) {
        alert('âœ… Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯');
        location.reload();
      } else {
        const text = await response.text();
        alert('âŒ Ø®Ø·Ø§: ' + text);
      }
    } catch (err) {
      alert('âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ±');
      console.error(err);
    }
  });

  function openLogPopup() {
    document.getElementById('log-popup').style.display = 'flex';
  }
  function closeLogPopup() {
    document.getElementById('log-popup').style.display = 'none';
  }

  document.getElementById('log-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    try {
      const response = await fetch(`/projects/{{ project.id }}/add-log`, {
        method: "POST",
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      if (response.ok) {
        alert("âœ… Ù„Ø§Ú¯ Ø«Ø¨Øª Ø´Ø¯");
        location.reload();
      } else {
        const error = await response.text();
        alert("âŒ Ø®Ø·Ø§: " + error);
      }
    } catch (err) {
      alert("âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡");
      console.error(err);
    }
  });

  function openEditPopup() {
    document.getElementById('edit-project-popup').style.display = 'flex';
  }
  function closeEditPopup() {
    document.getElementById('edit-project-popup').style.display = 'none';
  }

  document.getElementById('edit-project-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    try {
      const response = await fetch(`/projects/{{ project.id }}/edit`, {
        method: "POST",
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      if (response.ok) {
        alert("âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯");
        location.reload();
      } else {
        const error = await response.text();
        alert("âŒ Ø®Ø·Ø§: " + error);
      }
    } catch (err) {
      alert("âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ±");
      console.error(err);
    }
  });

  async function deleteProject() {
    if (!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
    try {
      const response = await fetch(`/projects/{{ project.id }}/delete`, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      if (response.ok) {
        alert("âœ… Ù¾Ø±ÙˆÚ˜Ù‡ Ø­Ø°Ù Ø´Ø¯");
        window.location.href = "/projects";
      } else {
        const text = await response.text();
        alert("âŒ Ø®Ø·Ø§: " + text);
      }
    } catch (err) {
      alert("âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ±");
    }
  }


  function editLog(logId) {
  fetch(`/projects/log/${logId}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById('edit-log-id').value = logId;
      document.getElementById('edit-log-note').value = data.note;
      document.getElementById('edit-log-created-by').value = data.created_by || '';
      document.getElementById('edit-log-type').value = data.type;
      document.getElementById('edit-log-popup').style.display = 'flex';
    })
    .catch(err => {
      alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù„Ø§Ú¯");
      console.error(err);
    });
}

function closeEditLogPopup() {
  document.getElementById('edit-log-popup').style.display = 'none';
}

document.getElementById('edit-log-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  try {
    const response = await fetch(`/projects/log/${formData.get('log_id')}/edit`, {
      method: "POST",
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    if (response.ok) {
      alert("âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø«Ø¨Øª Ø´Ø¯");
      location.reload();
    } else {
      const err = await response.text();
      alert("âŒ Ø®Ø·Ø§: " + err);
    }
  } catch (err) {
    alert("âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡");
    console.error(err);
  }
});

async function deleteLog() {
  const logId = document.getElementById('edit-log-id').value;
  if (!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù„Ø§Ú¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
  try {
    const response = await fetch(`/projects/log/${logId}/delete`, {
      method: "POST",
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    if (response.ok) {
      alert("âœ… Ù„Ø§Ú¯ Ø­Ø°Ù Ø´Ø¯");
      location.reload();
    } else {
      const text = await response.text();
      alert("âŒ Ø®Ø·Ø§: " + text);
    }
  } catch (err) {
    alert("âŒ Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ± ÛŒØ§ Ø´Ø¨Ú©Ù‡");
  }
}

</script>
{% endblock %}
