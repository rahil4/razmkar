{% extends "base.html" %}
{% block title %}مدیریت پروژه‌ها{% endblock %}
{% block header %}پروژه‌ها – کنترل سریع{% endblock %}

{% block extra_head %}
<style>
  /* === فقط برای این صفحه (اسکوپ) === */
  .p-manage .status-dot{display:inline-block;width:10px;height:10px;border-radius:999px;margin-left:.35rem;vertical-align:middle;border:1px solid transparent}
  .p-manage .dot-draft{background:#bdbdbd;border-color:#bdbdbd}
  .p-manage .dot-active{background:#0aa678;border-color:#0aa678}
  .p-manage .dot-waiting{background:#f0ad00;border-color:#f0ad00}
  .p-manage .dot-completed{background:#1e88e5;border-color:#1e88e5}
  .p-manage .dot-cancelled{background:#d32f2f;border-color:#d32f2f}

  .p-manage .select-plain{
    border:none !important;background:transparent !important;padding:0 .2rem !important;
    outline:none !important;box-shadow:none !important;appearance:none;cursor:pointer;
  }

  /* Drawer */
  .p-manage .drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,.15);display:none;z-index:999}
  .p-manage .drawer{
    position:fixed;top:0;right:0;height:100vh;width:420px;max-width:92vw;background:#fff;
    box-shadow:-2px 0 12px rgba(0,0,0,.08);transform:translateX(100%);transition:transform .25s ease;
    z-index:1000;display:flex;flex-direction:column
  }
  .p-manage .drawer.open{transform:translateX(0)}
  .p-manage .drawer-header{padding:.9rem 1rem;border-bottom:1px solid #f0f0f0;display:flex;align-items:center;justify-content:space-between;gap:.5rem}
  .p-manage .drawer-body{padding:.9rem 1rem;overflow:auto}
  .p-manage .muted{color:#666;font-size:.9rem}

  /* Badge وضعیت داخل Drawer */
  .p-manage .status{padding:.15rem .45rem;border-radius:999px;font-size:.8rem;border:1px solid transparent}
  .p-manage .st-draft{color:#777;background:#f7f7f7}
  .p-manage .st-active{color:#0a6;background:#e8fff5}
  .p-manage .st-waiting{color:#a60;background:#fff6e6}
  .p-manage .st-completed{color:#06c;background:#eaf4ff}
  .p-manage .st-cancelled{color:#b00;background:#ffecec}

  /* مأموریت‌ها در Drawer */
  .p-manage .missions-head{display:flex;align-items:center;justify-content:space-between;gap:.6rem;margin:.6rem 0}
  .p-manage .mchips{display:flex;gap:.4rem;flex-wrap:wrap}
  .p-manage .mchip{background:#f7f7f7;border:1px solid #eee;border-radius:999px;padding:.15rem .5rem;font-size:.8rem}
  .p-manage .mfilter{display:flex;gap:.4rem;align-items:center;flex-wrap:wrap}
  .p-manage .mlist{display:flex;flex-direction:column;gap:.45rem}
  .p-manage .mi{border:1px solid #f3f3f3;border-radius:10px;padding:.45rem .6rem;display:flex;align-items:center;justify-content:space-between}
  .p-manage .mi .left{display:flex;align-items:center;gap:.5rem;min-width:0}
  .p-manage .mi .ttl{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .p-manage .mi .meta{color:#666;font-size:.85rem}
  .p-manage .mdot{display:inline-block;width:10px;height:10px;border-radius:999px;border:1px solid transparent}
  .p-manage .mdot-todo{background:#bdbdbd;border-color:#bdbdbd}
  .p-manage .mdot-in_progress{background:#1e88e5;border-color:#1e88e5}
  .p-manage .mdot-done{background:#0aa678;border-color:#0aa678}
  .p-manage .mdot-cancelled{background:#d32f2f;border-color:#d32f2f}
  .p-manage .mi.overdue .ttl{color:#c62828}

  /* دسته‌بندی مأموریت (Badge) */
  .p-manage .mcat{display:inline-block;padding:.05rem .4rem;border-radius:999px;font-size:.75rem;border:1px solid transparent}
  .p-manage .mcat-field{background:#eaf7ff;color:#036;border-color:#cfe8ff}
  .p-manage .mcat-adm{background:#eafff4;color:#064;border-color:#c8f3e0}
  .p-manage .mcat-desk{background:#fff6db;color:#7a5;border-color:#ffe9a3}
  .p-manage .mcat-unk{background:#f5f5f5;color:#666;border-color:#eee}
</style>
{% endblock %}

{% block content %}
<div class="p-manage">

  <!-- CSRF (در صورت وجود) -->
  <input type="hidden" id="csrf_token" value="{{ csrf_token() if csrf_token is defined else '' }}">

  {# برچسب‌های فارسی وضعیت #}
  {% set STATUS_LABELS = {
    'draft':'پیش نویس',
    'active':'فعال',
    'waiting':'درانتظار',
    'completed':'اتمام',
    'cancelled':'لغو'
  } %}

  <!-- نوار کنترل‌ها + KPI -->
  <div class="flex items-center justify-between wrap gap-2 mb-2">
    <form method="get" id="filtersForm" action="{{ url_for('projects.manage_projects') }}" class="flex items-center wrap gap-2">
      <input class="input" type="text" name="q" value="{{ q }}" placeholder="جستجو (نام/هدف یا #ID)">

      <select class="select" name="status">
        <option value="">وضعیت: همه</option>
        {% for s in ["draft","active","waiting","completed","cancelled"] %}
          <option value="{{ s }}" {% if status_q==s %}selected{% endif %}>{{ STATUS_LABELS[s] }}</option>
        {% endfor %}
      </select>

      <select class="select" name="sort">
        {% for s in ["id","client","created","status"] %}
          <option value="{{ s }}" {% if sort==s %}selected{% endif %}>مرتب‌سازی: {{ s }}</option>
        {% endfor %}
      </select>

      <select class="select" name="order">
        {% for s in ["desc","asc"] %}
          <option value="{{ s }}" {% if order==s %}selected{% endif %}>ترتیب: {{ s }}</option>
        {% endfor %}
      </select>

      <select class="select" name="per_page">
        {% for p in [25,50,100] %}
          <option value="{{ p }}" {% if per_page==p %}selected{% endif %}>در صفحه: {{ p }}</option>
        {% endfor %}
      </select>

      <label class="flex items-center gap-1">
        <input type="checkbox" name="group" value="1" {% if group %}checked{% endif %}>
        گروه‌بندی وضعیت
      </label>

      <input type="hidden" name="page" value="{{ pagination.page if pagination is defined else 1 }}">
      <button class="btn btn-primary" type="submit">اعمال</button>
    </form>

    <div class="flex items-center gap-2 wrap">
      <span class="chip">پیش نویس: {{ counters.draft }}</span>
      <span class="chip">فعال: {{ counters.active }}</span>
      <span class="chip">درانتظار: {{ counters.waiting }}</span>
      <span class="chip">اتمام: {{ counters.completed }}</span>
      <span class="chip">لغو: {{ counters.cancelled }}</span>
    </div>
  </div>

  {% if group %}
    {# گروه‌بندی بر اساس وضعیت #}
    {% set statuses = ["active","waiting","draft","completed","cancelled"] %}
    {% for st in statuses %}
      <h3 class="h2 mt-2">{{ STATUS_LABELS[st] }}</h3>
      <table class="table row-hover projects">
        <thead>
          <tr>
            <th>ID</th>
            <th>نام مشتری</th>
            <th>هدف</th>
            <th>تاریخ ایجاد</th>
            <th>وضعیت</th>
          </tr>
        </thead>
        <tbody>
          {% for p in projects if p.status.name == st %}
            <tr class="table-row"
                data-id="{{ p.id }}"
                data-client="{{ p.client_name }}"
                data-goal="{{ p.goal }}"
                data-status="{{ p.status.name }}"
                data-status-label="{{ p.status.value }}"
                data-created="{{ p.created_at | to_jalali | to_persian_number }}"
                onclick="openRow(this)">
              <td>{{ p.id }}</td>
              <td>{{ p.client_name }}</td>
              <td>{{ p.goal }}</td>
              <td>{{ p.created_at | to_jalali | to_persian_number }}</td>
              <td>
                <span class="status-dot dot-{{ p.status.name }}" title="{{ p.status.value }}" aria-label="{{ p.status.value }}"></span>
                <select onchange="updateStatus(event, {{ p.id }})"
                        onclick="event.stopPropagation()"
                        class="select-plain">
                  {% for s in ["draft","active","waiting","completed","cancelled"] %}
                    <option value="{{ s }}" {% if p.status.name==s %}selected{% endif %}>{{ STATUS_LABELS[s] }}</option>
                  {% endfor %}
                </select>
              </td>
            </tr>
          {% else %}
            <tr><td colspan="5" class="muted">خالی</td></tr>
          {% endfor %}
        </tbody>
      </table>
    {% endfor %}
  {% else %}
    {# فهرست تخت #}
    <table class="table row-hover projects">
      <thead>
        <tr>
          <th><a href="#" onclick="setSort('id');return false;">ID</a></th>
          <th><a href="#" onclick="setSort('client');return false;">نام مشتری</a></th>
          <th>هدف</th>
          <th><a href="#" onclick="setSort('created');return false;">تاریخ ایجاد</a></th>
          <th><a href="#" onclick="setSort('status');return false;">وضعیت</a></th>
        </tr>
      </thead>
      <tbody>
        {% for p in projects %}
          <tr class="table-row"
              data-id="{{ p.id }}"
              data-client="{{ p.client_name }}"
              data-goal="{{ p.goal }}"
              data-status="{{ p.status.name }}"
              data-status-label="{{ p.status.value }}"
              data-created="{{ p.created_at | to_jalali | to_persian_number }}"
              onclick="openRow(this)">
            <td>{{ p.id }}</td>
            <td>{{ p.client_name }}</td>
            <td>{{ p.goal }}</td>
            <td>{{ p.created_at | to_jalali | to_persian_number }}</td>
            <td>
              <span class="status-dot dot-{{ p.status.name }}" title="{{ p.status.value }}" aria-label="{{ p.status.value }}"></span>
              <select onchange="updateStatus(event, {{ p.id }})"
                      onclick="event.stopPropagation()"
                      class="select-plain">
                {% for s in ["draft","active","waiting","completed","cancelled"] %}
                  <option value="{{ s }}" {% if p.status.name==s %}selected{% endif %}>{{ STATUS_LABELS[s] }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {% if pagination is defined %}
    <div class="flex items-center gap-2 mt-2">
      {% if pagination.has_prev %}
        <a href="#" class="btn btn-ghost" onclick="setPage({{ pagination.prev_num }});return false;">← قبلی</a>
      {% else %}
        <span class="btn btn-ghost">← قبلی</span>
      {% endif %}

      <span class="chip">صفحه {{ pagination.page }} از {{ pagination.pages }}</span>

      {% if pagination.has_next %}
        <a href="#" class="btn btn-ghost" onclick="setPage({{ pagination.next_num }});return false;">بعدی →</a>
      {% else %}
        <span class="btn btn-ghost">بعدی →</span>
      {% endif %}
    </div>
  {% endif %}

  <!-- Drawer -->
  <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-header">
      <div style="min-width:0;">
        <div id="dTitle" style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
        <div class="muted" id="dMeta"></div>
      </div>
      <div class="flex items-center gap-2">
        <span class="status" id="dStatusBadge"></span>
        <select class="select" id="dStatusSelect" onchange="updateStatusInDrawer(event)">
          {% for s in ["draft","active","waiting","completed","cancelled"] %}
            <option value="{{ s }}">{{ STATUS_LABELS[s] }}</option>
          {% endfor %}
        </select>
        <button class="btn" onclick="closeDrawer()">✕</button>
      </div>
    </div>
    <div class="drawer-body">
      <div class="mt-2">
        <a id="dFullLink" class="btn" href="#" target="_blank" rel="noopener">نمایش کامل ↗</a>
      </div>

      <!-- ===== مأموریت‌ها ===== -->
      <div class="missions-head">
        <h3 class="h2" style="margin:0;">ماموریت‌ها</h3>
        <div class="mfilter">
          <select id="mStatusFilter" class="select-plain" onchange="reloadMissions()">
            <option value="">همه وضعیت‌ها</option>
            <option value="todo">ثبت‌شده</option>
            <option value="in_progress">در حال انجام</option>
            <option value="done">انجام‌شده</option>
            <option value="cancelled">لغو</option>
          </select>
          <input id="mQuery" class="input" placeholder="جستجوی مأموریت…" onkeydown="if(event.key==='Enter') reloadMissions()">
        </div>
      </div>
      <div class="mchips" id="mCounters"></div>
      <div class="mlist" id="mList">
        <div class="muted">— در حال بارگذاری مأموریت‌ها…</div>
      </div>
    </div>
  </aside>

</div> {# /p-manage #}

<script>
  const CAT_LABELS = { field:'میدانی', administrative:'اداری', desk:'دفتری', unknown:'نامشخص' };
  const CAT_CLASS  = { field:'mcat-field', administrative:'mcat-adm', desk:'mcat-desk', unknown:'mcat-unk' };
  // اضافه: برای استفاده در title لیست مأموریت‌ها
  const MISSION_LABELS = { todo:'ثبت‌شده', in_progress:'در حال انجام', done:'انجام‌شده', cancelled:'لغو' };
</script>

<script>
  function getCsrf(){ return document.getElementById('csrf_token')?.value || ''; }

  // برچسب‌های فارسی برای وضعیت پروژه
  const STATUS_LABELS = {
    draft: 'پیش نویس',
    active: 'فعال',
    waiting: 'درانتظار',
    completed: 'اتمام',
    cancelled: 'لغو',
  };

  // تغییر وضعیت از داخل جدول
  function updateStatus(ev, projectId){
    ev.stopPropagation();
    const newStatus = ev.target.value;
    fetch(`/projects/${projectId}/status`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'X-CSRFToken': getCsrf(), 'X-Requested-With':'XMLHttpRequest' },
      body: JSON.stringify({ status: newStatus })
    })
    .then(r => r.json())
    .then(res => {
      if(!res.ok) throw new Error(res.error || 'update failed');

      const row = ev.target.closest('tr');
      const dot = row.querySelector('.status-dot');
      if (dot){
        dot.className = `status-dot dot-${res.new_status}`;
        dot.title = STATUS_LABELS[res.new_status];
        dot.setAttribute('aria-label', STATUS_LABELS[res.new_status]);
      }
      row.dataset.status = res.new_status;
      row.dataset.statusLabel = STATUS_LABELS[res.new_status];

      // هماهنگ با Drawer اگر باز است
      const sel = document.getElementById('dStatusSelect');
      if (sel && sel.dataset.projectId == projectId){
        const badge = document.getElementById('dStatusBadge');
        badge.textContent = STATUS_LABELS[res.new_status];
        badge.className = `status st-${res.new_status}`;
        sel.value = res.new_status;
      }
    })
    .catch(err => {
      console.error(err);
      alert('خطای شبکه یا پاسخ نامعتبر');
    });
  }

  // کلیک روی سطر: باز کردن Drawer
  let CURRENT_PROJECT_ID = null;

  function openRow(rowEl){
    try{
      const data = {
        id: rowEl.dataset.id,
        client: rowEl.dataset.client,
        goal: rowEl.dataset.goal,
        status: rowEl.dataset.status,
        statusLabel: rowEl.dataset.statusLabel,
        created: rowEl.dataset.created,
      };
      const url = new URL(window.location.href);
      url.searchParams.set('selected', data.id);
      history.pushState({ selected: data.id }, '', url);
      openDrawer(data);
    }catch(e){
      console.error('openRow error:', e);
    }
  }

  function openDrawer(data){
    CURRENT_PROJECT_ID = data.id;

    const overlay = document.getElementById('drawerOverlay');
    const drawer  = document.getElementById('drawer');
    const badge   = document.getElementById('dStatusBadge');
    const sel     = document.getElementById('dStatusSelect');

    document.getElementById('dTitle').textContent = `${data.client} — ${data.goal}`;
    document.getElementById('dMeta').textContent  = `ID: ${data.id} · ایجاد: ${data.created}`;

    badge.textContent = STATUS_LABELS[data.status] || data.statusLabel || data.status;
    badge.className = `status st-${data.status}`;

    sel.value = data.status;
    sel.dataset.projectId = data.id;
    drawer.dataset.projectId = data.id; // fallback

    document.getElementById('dFullLink').href = `/projects/${data.id}`;

    overlay.style.display = 'block';
    drawer.classList.add('open');
    drawer.setAttribute('aria-hidden', 'false');

    // مأموریت‌ها را بارگذاری کن
    if (typeof reloadMissions === 'function') reloadMissions();
  }

  function closeDrawer(updateHistory = true){
    const overlay = document.getElementById('drawerOverlay');
    const drawer  = document.getElementById('drawer');
    overlay.style.display = 'none';
    drawer.classList.remove('open');
    drawer.setAttribute('aria-hidden', 'true');
    if (updateHistory){
      const url = new URL(window.location.href);
      url.searchParams.delete('selected');
      history.replaceState({}, '', url);
    }
  }

  // تغییر وضعیت از داخل Drawer
  function updateStatusInDrawer(ev){
    const newStatus = ev.target.value;
    const drawer = document.getElementById('drawer');
    const projectId = ev.target.dataset.projectId || drawer.dataset.projectId;

    fetch(`/projects/${projectId}/status`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'X-CSRFToken': getCsrf(), 'X-Requested-With':'XMLHttpRequest' },
      body: JSON.stringify({ status: newStatus })
    })
    .then(r=>r.json())
    .then(res=>{
      if(!res.ok) throw new Error(res.error || 'update failed');

      const badge = document.getElementById('dStatusBadge');
      badge.textContent = STATUS_LABELS[res.new_status];
      badge.className = `status st-${res.new_status}`;

      const row = document.querySelector(`tr.table-row[data-id="${projectId}"]`);
      if (row){
        row.dataset.status = res.new_status;
        row.dataset.statusLabel = STATUS_LABELS[res.new_status];
        const dot = row.querySelector('.status-dot');
        if (dot){
          dot.className = `status-dot dot-${res.new_status}`;
          dot.title = STATUS_LABELS[res.new_status];
          dot.setAttribute('aria-label', STATUS_LABELS[res.new_status]);
        }
        const rowSelect = row.querySelector('select.select-plain');
        if (rowSelect) rowSelect.value = res.new_status;
      }
    })
    .catch(err=>{
      console.error(err);
      alert('خطای شبکه یا پاسخ نامعتبر');
    });
  }

  // سورت و پیجر با فرم (مثل نسخه ZIP)
  function getForm(){ return document.getElementById('filtersForm'); }
  function setSort(col){
    const f = getForm();
    const sortSel  = f.querySelector('select[name=sort]');
    const orderSel = f.querySelector('select[name=order]');
    const pageInp  = f.querySelector('input[name=page]');
    if (sortSel.value === col) {
      orderSel.value = (orderSel.value === 'asc') ? 'desc' : 'asc';
    } else {
      sortSel.value = col;
      orderSel.value = 'asc';
    }
    pageInp.value = 1;
    f.submit();
  }
  function setPage(n){
    const f = getForm();
    f.querySelector('input[name=page]').value = n;
    f.submit();
  }

  // حمایت از Back/Forward
  window.addEventListener('popstate', ()=>{
    const url = new URL(window.location.href);
    const id = url.searchParams.get('selected');
    if (id){
      const row = document.querySelector(`tr.table-row[data-id="${id}"]`);
      if (row){
        openDrawer({
          id: row.dataset.id,
          client: row.dataset.client,
          goal: row.dataset.goal,
          status: row.dataset.status,
          statusLabel: row.dataset.statusLabel,
          created: row.dataset.created,
        });
      }
    } else {
      closeDrawer(false);
    }
  });

  // اگر صفحه با ?selected= لود شد، Drawer را باز کن
  document.addEventListener('DOMContentLoaded', ()=>{
    const url = new URL(window.location.href);
    const id = url.searchParams.get('selected');
    if (id){
      const row = document.querySelector(`tr.table-row[data-id="${id}"]`);
      if (row){
        openDrawer({
          id: row.dataset.id,
          client: row.dataset.client,
          goal: row.dataset.goal,
          status: row.dataset.status,
          statusLabel: row.dataset.statusLabel,
          created: row.dataset.created,
        });
      }
    }
  });

  /* ===== Drawer Missions ===== */
  function reloadMissions(){
    if (!CURRENT_PROJECT_ID) return;
    const status = document.getElementById('mStatusFilter').value;
    const q = document.getElementById('mQuery').value.trim();

    const list = document.getElementById('mList');
    list.innerHTML = '<div class="muted">— در حال بارگذاری مأموریت‌ها…</div>';

    const url = new URL(`/projects/${CURRENT_PROJECT_ID}/missions`, window.location.origin);
    if (status) url.searchParams.set('status', status);
    if (q) url.searchParams.set('q', q);
    url.searchParams.set('limit', '50');
    url.searchParams.set('with_category', '1');

    fetch(url.toString(), { headers: { 'X-Requested-With':'XMLHttpRequest' }})
      .then(async (r) => {
        const text = await r.text();
        let data;
        try { data = JSON.parse(text); }
        catch (e) { throw new Error(text.replace(/<[^>]*>/g, ' ').slice(0, 180) || `HTTP ${r.status}`); }
        if (!r.ok || data.ok === false) throw new Error(data.error || `HTTP ${r.status}`);
        return data;
      })
      .then(data => {
        renderMissionCounters(data.counters || {});
        renderMissionList(data.items || []);
      })
      .catch(err => {
        console.error('missions fetch failed:', err);
        list.innerHTML = `<div class="muted">خطا: ${err.message}</div>`;
      });
  }

  function renderMissionCounters(counters){
    const el = document.getElementById('mCounters');
    const order = ['todo','in_progress','done','cancelled'];
    const labels = { todo:'ثبت‌شده', in_progress:'در حال انجام', done:'انجام‌شده', cancelled:'لغو' };
    el.innerHTML = order.map(k => {
      const c = (k in counters) ? counters[k] : '—';
      const t = labels[k] || k;
      return `<span class="mchip">${t}: ${c}</span>`;
    }).join('');
  }

  function renderMissionList(items){
    const el = document.getElementById('mList');
    if (!items.length){
      el.innerHTML = '<div class="muted">مأموریتی یافت نشد.</div>';
      return;
    }
    const today = new Date().toISOString().slice(0,10);

    el.innerHTML = items.map(m => {
      const code = (m.status || '').toLowerCase();
      const label = m.status_label || (MISSION_LABELS[code] || code);
      const dotMap = { todo:'mdot-todo', in_progress:'mdot-in_progress', done:'mdot-done', cancelled:'mdot-cancelled' };
      const dot = dotMap[code] || 'mdot-todo';
      const due = (m.due_date ? m.due_date.slice(0,10) : '—');
      const overdue = (m.due_date && code !== 'done' && code !== 'cancelled' && m.due_date.slice(0,10) < today);

      const cat = (m.category || 'unknown');
      const catLbl = CAT_LABELS[cat] || 'نامشخص';
      const catClass = CAT_CLASS[cat] || 'mcat-unk';

      const tags = (m.tags && m.tags.length) ? ('#' + m.tags.join(' #')) : '';

      return `
        <div class="mi ${overdue ? 'overdue' : ''}">
          <div class="left" title="${label}">
            <span class="mdot ${dot}"></span>
            <div>
              <div class="ttl">${escapeHtml(m.title || ('ماموریت #' + m.id))}</div>
              <div class="meta">
                <span class="mcat ${catClass}">${catLbl}</span>
                &nbsp;· موعد: ${due}
                ${tags ? ' · ' + escapeHtml(tags) : ''}
              </div>
            </div>
          </div>
          <div>
            <a class="btn" href="/razmkar/${m.id}" target="_blank" rel="noopener">باز کردن ↗</a>
          </div>
        </div>
      `;
    }).join('');
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, ch =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])
    );
  }
</script>

{% endblock %}
