{% extends "base.html" %}

{% block title %}داشبورد{% endblock %}

{% block header %}داشبورد{% endblock %}

{% block content %}
  <section>
    <h2>پروژه‌های فعال</h2>
    {% if active_projects %}
      <ul>
        {% for project in active_projects %}
          <li>
            <a href="{{ url_for('projects.project_detail', project_id=project.id) }}">
              {{ project.client_name }} - {{ project.goal }}
            </a>
            {% if project.next_due %}
              <span style="color:#999">({{ project.next_due | to_jalali | to_persian_number }})</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>پروژه فعالی یافت نشد.</p>
    {% endif %}
  </section>

  <hr>

  <section>
    <h2>ماموریت‌های نیازمند اقدام</h2>
    {% if pending_razmkars %}
      <ul>
        {% for rk in pending_razmkars %}
          <li>
           <a href="{{ url_for('razmkar.razmkar_detail', razmkar_id=rk.id) }}">
  <strong>[{{ rk.project.client_name }} - {{ rk.project.goal }}] :</strong>
  {{ rk.mission }} - {{ rk.status.value }}
</a>
            {% if rk.due_date %}
              <span style="color:#999">({{ rk.due_date | to_jalali | to_persian_number }})</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>ماموریتی برای پیگیری وجود ندارد.</p>
    {% endif %}
  </section>

  <hr>

  <section>
    <h2>موارد نزدیک به موعد</h2>
    {% if upcoming_razmkars %}
      <ul>
        {% for rk in upcoming_razmkars %}
          <li>
           <a href="{{ url_for('razmkar.razmkar_detail', razmkar_id=rk.id) }}">
  {{ rk.project.client_name }} - {{ rk.project.goal }} :
  {{ rk.mission }}
</a>

            <strong style="color:red">({{ rk.due_date | to_jalali | to_persian_number }})</strong>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>ماموریتی با تاریخ نزدیک وجود ندارد.</p>
    {% endif %}
  </section>

  <hr>

  <section>
    <a href="javascript:void(0);" onclick="openCreatePopup()">➕ افزودن پروژه جدید</a>
  </section>

  <!-- پاپ‌آپ ایجاد پروژه -->
  <div id="create-project-popup" class="popup-overlay" style="display:none;">
    <div class="popup">
      <h3>ایجاد پروژه جدید</h3>
      <form id="create-project-form">
        <input name="client_name" placeholder="نام کارفرما" required><br>
        <input name="goal" placeholder="هدف پروژه" required><br>
        <select name="status" required>
          <option value="draft">پیش‌نویس</option>
          <option value="active">فعال</option>
          <option value="waiting">در انتظار</option>
          <option value="completed">اتمام</option>
          <option value="cancelled">لغو</option>
        </select><br>
        <button type="submit">ذخیره</button>
        <button type="button" onclick="closeCreatePopup()">لغو</button>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  function openCreatePopup() {
    document.getElementById('create-project-popup').style.display = 'flex';
  }

  function closeCreatePopup() {
    document.getElementById('create-project-popup').style.display = 'none';
  }

  document.getElementById('create-project-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    try {
      const response = await fetch("/projects/", {
        method: "POST",
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      if (response.ok) {
        alert("✅ پروژه ایجاد شد");
        location.reload();
      } else {
        const text = await response.text();
        alert("❌ خطا: " + text);
      }
    } catch (err) {
      alert("❌ خطای شبکه");
    }
  });
</script>
{% endblock %}
